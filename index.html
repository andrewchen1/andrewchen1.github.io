<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"www.andrewchen1.top","root":"/","scheme":"Pisces","version":"7.7.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="小夫的笔记">
<meta property="og:url" content="https://www.andrewchen1.top/index.html">
<meta property="og:site_name" content="小夫的笔记">
<meta property="article:author" content="小夫">
<meta property="article:tag" content="笔记">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://www.andrewchen1.top/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false
  };
</script>

  <title>小夫的笔记</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">小夫的笔记</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">但行好事 莫问前程</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://www.andrewchen1.top/2019/10/26/%E6%9E%84%E9%80%A0%E6%95%B0%E6%8D%AE%E6%8A%BD%E8%B1%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="小夫">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小夫的笔记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/10/26/%E6%9E%84%E9%80%A0%E6%95%B0%E6%8D%AE%E6%8A%BD%E8%B1%A1/" class="post-title-link" itemprop="url">构造数据抽象</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-10-26 19:02:24" itemprop="dateCreated datePublished" datetime="2019-10-26T19:02:24+08:00">2019-10-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-11-09 18:08:53" itemprop="dateModified" datetime="2019-11-09T18:08:53+08:00">2019-11-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%9A%84%E6%9E%84%E9%80%A0%E5%92%8C%E8%A7%A3%E9%87%8A/" itemprop="url" rel="index"><span itemprop="name">计算机的构造和解释</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="构造数据抽象"><a href="#构造数据抽象" class="headerlink" title="构造数据抽象"></a>构造数据抽象</h2><ul>
<li>复合数据</li>
<li>闭包</li>
<li>符号表达式</li>
</ul>
<h2 id="数据抽象导引"><a href="#数据抽象导引" class="headerlink" title="数据抽象导引"></a>数据抽象导引</h2><p>假设make-rat 能使分数最简化</p>
<p>假设 number 能获得分子，denom 能获得分母 </p>
<ul>
<li>加法</li>
</ul>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">add-rat</span> x y) </span><br><span class="line">  (<span class="name">make-rat</span> (<span class="name"><span class="builtin-name">+</span></span> (<span class="name"><span class="builtin-name">*</span></span>(<span class="name">number</span> x) (<span class="name">denom</span> y))</span><br><span class="line">               (<span class="name"><span class="builtin-name">*</span></span> (<span class="name">denom</span> x) (<span class="name">number</span> y)))</span><br><span class="line">            (<span class="name"><span class="builtin-name">*</span></span> (<span class="name">denom</span> x) (<span class="name">denom</span> y)))</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>

<ul>
<li>减法</li>
</ul>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">sub-rat</span> x y)</span><br><span class="line">  (<span class="name">make-rat</span> (<span class="name"><span class="builtin-name">-</span></span> (<span class="name"><span class="builtin-name">*</span></span>(<span class="name">number</span> x) (<span class="name">denom</span> y))</span><br><span class="line">               (<span class="name"><span class="builtin-name">*</span></span>(<span class="name">denom</span> x) (<span class="name">number</span> x))</span><br><span class="line">               )</span><br><span class="line">            (<span class="name"><span class="builtin-name">*</span></span> (<span class="name">denom</span> x) (<span class="name">denom</span> y)))</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>

<ul>
<li>乘法</li>
</ul>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">mul-rat</span> x y)</span><br><span class="line">  (<span class="name">make-rat</span> (<span class="name"><span class="builtin-name">*</span></span> (<span class="name">number</span> x) (<span class="name">number</span> y)</span><br><span class="line">               (<span class="name"><span class="builtin-name">*</span></span> (<span class="name">denom</span> x) (<span class="name">denom</span> y)))</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>

<ul>
<li>除法</li>
</ul>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">div-rat</span> x y)</span><br><span class="line">  (<span class="name">make-rat</span> (<span class="name"><span class="builtin-name">*</span></span> (<span class="name">number</span> x) (<span class="name">denom</span> y))</span><br><span class="line">            (<span class="name"><span class="builtin-name">*</span></span> (<span class="name">denom</span> y) (<span class="name">number</span> x)))</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>

<ul>
<li>判断是否相等</li>
</ul>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">equal-rat</span> x y) </span><br><span class="line">  (<span class="name"><span class="builtin-name">=</span></span> (<span class="name"><span class="builtin-name">*</span></span> (<span class="name">number</span> x) (<span class="name">denom</span> y)</span><br><span class="line">        (<span class="name"><span class="builtin-name">*</span></span> (<span class="name">denom</span> y) (<span class="name">number</span> x)))</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>

<ul>
<li>构造函数</li>
</ul>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> x (<span class="name"><span class="builtin-name">cons</span></span> <span class="number">1</span> <span class="number">2</span>))</span><br><span class="line">(<span class="name"><span class="builtin-name">car</span></span> x)</span><br><span class="line">(<span class="name"><span class="builtin-name">cdr</span></span> x)</span><br></pre></td></tr></table></figure>

<p>得到的结果分别是 1 和 2</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-rat</span> n d)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> (</span><br><span class="line">        (<span class="name">g</span> (<span class="name"><span class="builtin-name">gcd</span></span> n d))</span><br><span class="line">        )</span><br><span class="line">  	(<span class="name"><span class="builtin-name">cons</span></span> (<span class="name"><span class="builtin-name">/</span></span> n g) (<span class="name"><span class="builtin-name">/</span></span> d g))</span><br><span class="line">    )</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>

<p>而 gdc 最大公约数,之前我们介绍过， 可以通过中国余数的方式获得</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">gcd</span></span> n d)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">=</span></span> <span class="number">0</span> d) (<span class="name">n</span>)</span><br><span class="line">      (<span class="name"><span class="builtin-name">gcd</span></span> (<span class="name">d</span> (<span class="name">reminder</span> n d))</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>

<h2 id="层次性数据和闭包性质"><a href="#层次性数据和闭包性质" class="headerlink" title="层次性数据和闭包性质"></a>层次性数据和闭包性质</h2><p>序对为我们提供一种用于构造复合数据的基本“粘结剂”。我们还可以通过它去组合起序对。</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">cons</span></span> (<span class="name"><span class="builtin-name">cons</span></span> <span class="number">1</span> <span class="number">2</span>) (<span class="name"><span class="builtin-name">cons</span></span> <span class="number">1</span> <span class="number">2</span>))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">cons</span></span> (<span class="name"><span class="builtin-name">cons</span></span> <span class="number">1</span> (<span class="name"><span class="builtin-name">cons</span></span> <span class="number">2</span> <span class="number">3</span>)) <span class="number">4</span>)</span><br></pre></td></tr></table></figure>

<p>（⚠️ 上面的方式不是序列。）</p>
<p>我们可以建立元素本身也是序对的序对，这就是表结构得以作为一种表示工具的根本基础。我们把这种能力称为cons的闭包。</p>
<blockquote>
<p>术语 闭包 来自于抽象代数。在抽象代数里，一集元素称为在某个元算（操作）之下封闭。如果将该运算应用于这一集合中的元素，产生出的仍是该集合里的元素。</p>
</blockquote>
<h3 id="序列的表示"><a href="#序列的表示" class="headerlink" title="序列的表示"></a>序列的表示</h3><p>利用序对可以构造出的一类有用结构是<strong>序列</strong>。 和Java的数据结构比较对应数据结构是<strong>链表</strong></p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">cons</span></span> <span class="number">1</span> </span><br><span class="line">      (<span class="name"><span class="builtin-name">cons</span></span> <span class="number">2</span></span><br><span class="line">            (<span class="name"><span class="builtin-name">cons</span></span> <span class="number">3</span></span><br><span class="line">                  (<span class="name"><span class="builtin-name">cons</span></span> <span class="number">4</span> nil))))</span><br></pre></td></tr></table></figure>

<p>通过嵌套的cons形成的这样一个序对的序列称为一个<strong>表</strong>， 它和上面的程序等价</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">list</span></span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span>)</span><br></pre></td></tr></table></figure>

<p><strong>我们将car看作选取表的第一项的操作，将cdr看作选取表中除去第一项之后剩下的所有项形成的子表</strong></p>
<p>比方说我们想得到表的第n项</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">list-ref</span></span> item)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">=</span></span> <span class="number">0</span> item) (<span class="name"><span class="builtin-name">car</span></span> item)</span><br><span class="line">      (<span class="name"><span class="builtin-name">list-ref</span></span> (<span class="name"><span class="builtin-name">cdr</span></span> item) (<span class="name"><span class="builtin-name">-</span></span> item <span class="number">1</span>))))</span><br></pre></td></tr></table></figure>

<p>比方说append</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">append</span></span> list1 list2)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">=</span></span> nil list1) </span><br><span class="line">      (<span class="name">list2</span>)</span><br><span class="line">      (<span class="name"><span class="builtin-name">cons</span></span> (<span class="name"><span class="builtin-name">car</span></span> list1) (<span class="name"><span class="builtin-name">append</span></span>((<span class="name"><span class="builtin-name">cdr</span></span> list1) list2)))</span><br><span class="line">      )</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>

<p>首先找到list1的最后一个元素。 把list1最后一个元素的next设置为list2. 依次递归。其中过程中的list1和参数的list1不等价。</p>
<h3 id="对表的映射"><a href="#对表的映射" class="headerlink" title="对表的映射"></a>对表的映射</h3><p>$(1\ 2 \ 3) * 3 = (3 \ 6 \ 9)$</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">scale-list</span> items factor)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span></span><br><span class="line">   ( = nil items) </span><br><span class="line">   (<span class="name">nil</span>)</span><br><span class="line">   (</span><br><span class="line">    (<span class="name"><span class="builtin-name">cons</span></span>  (<span class="name"><span class="builtin-name">*</span></span> (<span class="name"><span class="builtin-name">car</span></span> items) factor) (<span class="name">scale-list</span> (<span class="name">crd</span> items) factor))</span><br><span class="line">    )</span><br><span class="line">   )</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>

<p>我们将其中的公共模式表述成一个高阶过程，这个高阶过程我们称之为<strong>map</strong>。返回将这一个过程应用于表中各个元素得到的结果形成的表</p>
<p>通式为</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">map</span></span> proc items)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">=</span></span> nil items)</span><br><span class="line">      (<span class="name">nil</span>)</span><br><span class="line">      (<span class="name"><span class="builtin-name">cons</span></span></span><br><span class="line">       (<span class="name">proc</span> (<span class="name"><span class="builtin-name">car</span></span> items))</span><br><span class="line">       (<span class="name"><span class="builtin-name">map</span></span> proc (<span class="name">crd</span> items))</span><br><span class="line">       )</span><br><span class="line">   )</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>

<p>有了这个公式我们可以简化上述集合的乘法</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">scale-list</span> items factor)</span><br><span class="line">  (<span class="name"><span class="builtin-name">map</span></span> (<span class="name"><span class="builtin-name">lambda</span></span> (x)</span><br><span class="line">         (<span class="name"><span class="builtin-name">*</span></span> x factors)</span><br><span class="line">         )</span><br><span class="line">       items)</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>

<h3 id="层次性结构"><a href="#层次性结构" class="headerlink" title="层次性结构"></a>层次性结构</h3><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">cons</span></span> (<span class="name"><span class="builtin-name">list</span></span> <span class="number">1</span> <span class="number">2</span>) (<span class="name"><span class="builtin-name">list</span></span> <span class="number">3</span> <span class="number">4</span>))</span><br></pre></td></tr></table></figure>

<p>我们把这种数据结构称之为<strong>树</strong></p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">count-leaves</span> x)</span><br><span class="line">  (<span class="name"><span class="builtin-name">cond</span></span> </span><br><span class="line">   ((<span class="name"><span class="builtin-name">null?</span></span> x) <span class="number">0</span>)</span><br><span class="line">   ((<span class="name"><span class="builtin-name">pair?</span></span> x)</span><br><span class="line">    	(<span class="name"><span class="builtin-name">+</span></span> (<span class="name">count-leaves</span> (<span class="name"><span class="builtin-name">car</span></span> x))</span><br><span class="line">         (<span class="name">count-leaves</span> (<span class="name"><span class="builtin-name">cdr</span></span> x))</span><br><span class="line">      ))</span><br><span class="line">   (<span class="name"><span class="builtin-name">else</span></span> <span class="number">1</span>)</span><br><span class="line">  )</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>其中pair? 的作用是检查是不是序对</p>
<h3 id="对树的映射"><a href="#对树的映射" class="headerlink" title="对树的映射"></a>对树的映射</h3><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">scale-tree</span> tree factor)</span><br><span class="line">  (<span class="name"><span class="builtin-name">map</span></span> (<span class="name"><span class="builtin-name">lambda</span></span> (sub-tree)</span><br><span class="line">           (<span class="name"><span class="builtin-name">if</span></span> </span><br><span class="line">              (<span class="name"><span class="builtin-name">pair?</span></span> sub-tree)</span><br><span class="line">              (<span class="name">scale-tree</span> sub-tree factor)</span><br><span class="line">              (<span class="name"><span class="builtin-name">*</span></span> factor sub-tree)</span><br><span class="line">             )</span><br><span class="line">     )</span><br><span class="line">         tree </span><br><span class="line">   )</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h3 id="序列作为一种约定的界面"><a href="#序列作为一种约定的界面" class="headerlink" title="序列作为一种约定的界面"></a>序列作为一种约定的界面</h3><p>以一棵树为参数，求值为奇数叶子的平方和</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">sum-odd-squares</span> tree)</span><br><span class="line">  (<span class="name"><span class="builtin-name">map</span></span> (<span class="name"><span class="builtin-name">lambda</span></span> (sub-tree) </span><br><span class="line">         (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">null?</span></span> sub-tree)</span><br><span class="line">                <span class="number">0</span></span><br><span class="line">                )</span><br><span class="line">               (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">pair?</span></span> sub-tree)</span><br><span class="line">                   (<span class="name"><span class="builtin-name">+</span></span> (<span class="name">sum-odd-squares</span> (<span class="name"><span class="builtin-name">car</span></span> sub-tree)) </span><br><span class="line">                      (<span class="name">sum-odd-squares</span> (<span class="name"><span class="builtin-name">cdr</span></span> sub-tree))</span><br><span class="line">                      )</span><br><span class="line">                   (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">=</span></span> <span class="number">1</span> (<span class="name">reminder</span> sub-tree <span class="number">2</span>))</span><br><span class="line">                       (<span class="name">square</span> sub-tree)</span><br><span class="line">                       )</span><br><span class="line">                   )</span><br><span class="line">         )</span><br><span class="line">    tree)</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>

<h3 id="构造偶数的斐波那契数列的表"><a href="#构造偶数的斐波那契数列的表" class="headerlink" title="构造偶数的斐波那契数列的表"></a>构造偶数的斐波那契数列的表</h3><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">fibs-iter</span> n_1 n_2 cur N total) </span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">=</span></span> cur N)</span><br><span class="line">      total</span><br><span class="line">      (<span class="name">fibs-iter</span> (<span class="name"><span class="builtin-name">+</span></span> n_1 n_2) n_1 (<span class="name"><span class="builtin-name">+</span></span> cur <span class="number">1</span>) N (<span class="name"><span class="builtin-name">+</span></span> n_1 total )))</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">fibs</span> N)</span><br><span class="line">  (<span class="name">fibs-iter</span> <span class="number">1</span> <span class="number">0</span> <span class="number">0</span> N <span class="number">0</span>)</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">even-fibs</span> n)</span><br><span class="line">  ( (<span class="name"><span class="builtin-name">lambda</span></span> (k) </span><br><span class="line">      (<span class="name"><span class="builtin-name">&gt;</span></span> k n)</span><br><span class="line">      	nil</span><br><span class="line">      (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">even?</span></span> (<span class="name">fibs</span> n))</span><br><span class="line">          (<span class="name"><span class="builtin-name">cons</span></span> (<span class="name">fibs</span> n)</span><br><span class="line">      )</span><br><span class="line">    )</span><br><span class="line">  )</span><br><span class="line">  (<span class="name"><span class="builtin-name">lambda</span></span> </span><br><span class="line">    (sub-list k) </span><br><span class="line">    (<span class="name"><span class="builtin-name">if</span></span> (</span><br><span class="line">           (<span class="name"><span class="builtin-name">&gt;</span></span> k n)</span><br><span class="line">         		nil</span><br><span class="line">           (<span class="name"><span class="builtin-name">if</span></span> </span><br><span class="line">            (<span class="name"><span class="builtin-name">even?</span></span> (<span class="name">fibs</span> n)) </span><br><span class="line">            (<span class="name"><span class="builtin-name">cons</span></span> (<span class="name">fibs</span> n) sub-list)</span><br><span class="line">            )</span><br><span class="line">           (</span><br><span class="line">            (<span class="name"><span class="builtin-name">&lt;</span></span> k n)</span><br><span class="line">            ()</span><br><span class="line">           )</span><br><span class="line">          </span><br><span class="line">          )</span><br><span class="line">        )</span><br><span class="line">    )</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>




      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://www.andrewchen1.top/2019/10/19/%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E7%9A%84%E5%9F%BA%E6%9C%AC%E5%85%83%E7%B4%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="小夫">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小夫的笔记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/10/19/%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E7%9A%84%E5%9F%BA%E6%9C%AC%E5%85%83%E7%B4%A0/" class="post-title-link" itemprop="url">程序设计的基本元素</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-10-19 14:26:00" itemprop="dateCreated datePublished" datetime="2019-10-19T14:26:00+08:00">2019-10-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-11-04 23:01:52" itemprop="dateModified" datetime="2019-11-04T23:01:52+08:00">2019-11-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%9A%84%E6%9E%84%E9%80%A0%E5%92%8C%E8%A7%A3%E9%87%8A/" itemprop="url" rel="index"><span itemprop="name">计算机的构造和解释</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="程序设计的基本元素"><a href="#程序设计的基本元素" class="headerlink" title="程序设计的基本元素"></a>程序设计的基本元素</h2><ol>
<li><p>基本表达式</p>
<p>用于表示语言所关心的最简单的个体</p>
</li>
<li><p>组合的方法</p>
<p>通过它们可以从比较简单的东西出发构造出复合的元素</p>
</li>
<li><p>抽象的方法</p>
<p>通过它们可以为复合对象命名，并将它们当作单去操作</p>
</li>
</ol>
<h3 id="表达式"><a href="#表达式" class="headerlink" title="表达式"></a>表达式</h3><p>（* 1 2 3 4）</p>
<p>像上面这样的表达式称为组合式，其构成方式就是用一对括号括起一些表达式，形成一个<strong>表</strong> 用于表示一个过程应用。在表最左边的元素被称为<strong>运算符</strong>，其他元素都称为运算对象。</p>
<h3 id="命名和环境"><a href="#命名和环境" class="headerlink" title="命名和环境"></a>命名和环境</h3><p>（define size 2）</p>
<h3 id="组合式的求值"><a href="#组合式的求值" class="headerlink" title="组合式的求值"></a>组合式的求值</h3><p>（ * （+ 2 （* 4 6） （+ 3 5 7））</p>
<h3 id="复合过程"><a href="#复合过程" class="headerlink" title="复合过程"></a>复合过程</h3><ul>
<li>数和算数计算是基本的数据和过程</li>
<li>组合式的嵌套提供了一种组织起多个操作的方法</li>
<li>定义是一种受限的抽象手段，它为名字关联相相应的值</li>
</ul>
<p>（define （<name> <formal parameters>） <body>）</p>
<h3 id="过程应用的代换模型"><a href="#过程应用的代换模型" class="headerlink" title="过程应用的代换模型"></a>过程应用的代换模型</h3><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">f</span> a)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">square</span> n)</span><br><span class="line">    (<span class="name"><span class="builtin-name">*</span></span> n n)</span><br><span class="line">    )</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">sum-of-squares</span> a)</span><br><span class="line">    (<span class="name"><span class="builtin-name">+</span></span> (<span class="name">square</span> (<span class="name"><span class="builtin-name">+</span></span> <span class="number">1</span> a)) (<span class="name">square</span>(<span class="name"><span class="builtin-name">+</span></span> <span class="number">2</span> a)))</span><br><span class="line">    )</span><br><span class="line">  (<span class="name">sum-of-squares</span> a)</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>

<p>要得到结果先要把式子替换成sum-of-squares的定义，进一步的要替换成square的定义。这样的计算过程被称为<strong>代换模型</strong>。</p>
<h3 id="应用序和正则序"><a href="#应用序和正则序" class="headerlink" title="应用序和正则序"></a>应用序和正则序</h3><p>这种“完全展开而后归约”的求值模式被称为<strong>正则序求值</strong>，对于上面的f 函数来说就是 变成</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">+</span></span> (<span class="name"><span class="builtin-name">*</span></span> (<span class="name"><span class="builtin-name">+</span></span> <span class="number">5</span> <span class="number">1</span>) (<span class="name"><span class="builtin-name">+</span></span> <span class="number">5</span> <span class="number">1</span>)) (<span class="name"><span class="builtin-name">*</span></span> (<span class="name"><span class="builtin-name">*</span></span> <span class="number">5</span> <span class="number">2</span>) (<span class="name"><span class="builtin-name">*</span></span> <span class="number">5</span> <span class="number">2</span>)))</span><br></pre></td></tr></table></figure>

<p>然后进行规约</p>
<p>与之相对应的是现在解释器里实际使用的“先求值参数而后应用”的方式，它称为<strong>应用序求值</strong>。</p>
<h3 id="条件表达式和谓词"><a href="#条件表达式和谓词" class="headerlink" title="条件表达式和谓词"></a>条件表达式和谓词</h3><p>（cond </p>
<p>​    (<p1> <e1>)</p>
<p>​    (<p2> <e2>)</p>
<p>）</p>
<p>(if (<p1>)  (<e1>) (<e2>) )</p>
<p>谓词中允许中使用的词</p>
<ul>
<li>(and <e1> … <ex>）</li>
<li>(or <e1> … <ex>)</li>
<li>(not <e>)</li>
</ul>
<h3 id="实例：采用牛顿法求平方根"><a href="#实例：采用牛顿法求平方根" class="headerlink" title="实例：采用牛顿法求平方根"></a>实例：采用牛顿法求平方根</h3><p>$ \frac { {x} / {y^2} + 2y} {3}$</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">square</span> x)</span><br><span class="line">  (<span class="name">x</span> * x)</span><br><span class="line">  )</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">cue</span> x)</span><br><span class="line">  (<span class="name">x</span> * x *x)</span><br><span class="line">  )</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> good_guess(<span class="name">this_guess</span> last_guess)</span><br><span class="line">  (<span class="name"><span class="builtin-name">&lt;</span></span> (<span class="name"><span class="builtin-name">abs</span></span> (<span class="name"><span class="builtin-name">-</span></span> this_guess last_guess)) <span class="number">0.0001</span>)</span><br><span class="line">  )</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> get_this_time_guess(<span class="name">last_guess</span> x)</span><br><span class="line">  (<span class="name"><span class="builtin-name">/</span></span> (<span class="name"><span class="builtin-name">+</span></span> (<span class="name"><span class="builtin-name">/</span></span> x square(<span class="name">last_guess</span>)) (<span class="name"><span class="builtin-name">*</span></span> <span class="number">2</span> last_guess)) <span class="number">3</span>)</span><br><span class="line">  )</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> cue_root_inter(<span class="name">last_guess</span> x) </span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name">good_guess</span> (<span class="name">get_this_time_guess</span> last_guess x) last_guess)</span><br><span class="line">                (<span class="name">get_this_time_guess</span> last_guess x)</span><br><span class="line">                (<span class="name">cue_root_inter</span> (<span class="name">get_this_time_guess</span> last_guess x) x)</span><br><span class="line">      )</span><br><span class="line">  )</span><br><span class="line">)</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">cue_root</span> x)</span><br><span class="line">  	cue_root_inter(<span class="name">1.0</span> x)</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>

<h3 id="过程作为黑箱抽象"><a href="#过程作为黑箱抽象" class="headerlink" title="过程作为黑箱抽象"></a>过程作为黑箱抽象</h3><p>与其说cue_root 是一个过程，还不如说它一个过程的的抽象</p>
<p><strong>局部名</strong></p>
<blockquote>
<p>过程的形式参数在过程体系里扮演着一种非常特殊的角色，在这里，形式参数的具体名字是什么，其实完全没有关系。这样的名字被称为<em>约束变量</em>。 如果一个变量不是被约束的，我们称它为自由的。</p>
<p>在good_guess中this_guess和last_guess是约束的，&lt; abs 是自由的。</p>
</blockquote>
<p><strong>内部定义和块结构</strong></p>
<p>目前的程序是几个相互分离的过程组成，如果统一到同一个方法块中。 这种嵌套的定义称为块结构</p>
<h2 id="过程与它们所产生的计算"><a href="#过程与它们所产生的计算" class="headerlink" title="过程与它们所产生的计算"></a>过程与它们所产生的计算</h2><p>我们现在已经考虑了程序设计中的一些要素</p>
<p>使用许多基本的算数操作</p>
<p>对这种操作进行组合</p>
<p>定义各种复合过程</p>
<h3 id="线性的递归和迭代"><a href="#线性的递归和迭代" class="headerlink" title="线性的递归和迭代"></a>线性的递归和迭代</h3><p>1.</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">factorial</span> n)</span><br><span class="line">  if (<span class="name"><span class="builtin-name">=</span></span> n <span class="number">1</span>)</span><br><span class="line">  (<span class="name">1</span>)</span><br><span class="line">  (<span class="name"><span class="builtin-name">*</span></span> n factorial(<span class="name"><span class="builtin-name">-</span></span> n <span class="number">1</span>)))</span><br></pre></td></tr></table></figure>

<p>2.</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">factorial</span> n)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">factorial-iter</span> product current_count max_count) </span><br><span class="line">    (<span class="name"><span class="builtin-name">if</span></span>(<span class="name"><span class="builtin-name">=</span></span> current max_count)</span><br><span class="line">       (<span class="name"><span class="builtin-name">*</span></span> product current)</span><br><span class="line">       (<span class="name">factorial-iter</span> (<span class="name"><span class="builtin-name">*</span></span> product current) (<span class="name"><span class="builtin-name">+</span></span> current <span class="number">1</span>) max_count)</span><br><span class="line">       )</span><br><span class="line">    )</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>

<p>在第1个中。代换模型解释出一个<em>推迟进行<em>的操作所形成的链条。收缩阶段表现为这些运算的实际进行。称为*</em>递归计算过程*<em>，它的长度随着n值而线性增长，这样的计算过程为一个</em>线性递归过程</em></p>
<p>在第2个中，没有任何增长或者收缩。在我们需要保存轨迹里，所有的东西就是变量product、current_count和max_count的值。我们称这种过程为一个<em>迭代计算过程</em>。迭代计算过程就是那种其状态可以用<strong>固定数据的状态变量描述的计算过程</strong></p>
<blockquote>
<p>从另一个角度来看这两个过程之间的对比。在迭代的情况里，在计算过程中的任何一点，那几个程序变量都提供了有关计算状态的完整表述。如果我们令上述计算在某两个步骤之间停下来，想要重新唤醒这一计算，只需要为解释器提供有关这三个变量的值。</p>
<p>对于递归计算而言，这里还存在着另外的一些隐含信息，它们由解释器维持着。</p>
</blockquote>
<p><strong>注意</strong></p>
<p>这不表示第二种方式不是递归。 只是解释器采用优化 把它优化成类似于while等的方式。我们称之为尾递归。</p>
<h3 id="树形递归"><a href="#树形递归" class="headerlink" title="树形递归"></a>树形递归</h3><h4 id="斐波那契数列"><a href="#斐波那契数列" class="headerlink" title="斐波那契数列"></a>斐波那契数列</h4><ol>
<li>递归方式调用</li>
</ol>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">fib</span> n) </span><br><span class="line">  (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">=</span></span> n <span class="number">1</span>) (<span class="name">1</span>))</span><br><span class="line">        ((<span class="name"><span class="builtin-name">=</span></span> n <span class="number">2</span>) (<span class="name">1</span>))</span><br><span class="line">        ((<span class="name"><span class="builtin-name">&gt;</span></span> n <span class="number">2</span>) (<span class="name"><span class="builtin-name">+</span></span> fib((<span class="name"><span class="builtin-name">-</span></span> n <span class="number">1</span>)) fib((<span class="name"><span class="builtin-name">-</span></span> n <span class="number">2</span>))))</span><br><span class="line">      )</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>迭代的方式调用</li>
</ol>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">fib</span> n)</span><br><span class="line">  			(<span class="name">fib-iter</span>(<span class="name">n</span> <span class="number">3</span> <span class="number">1</span> <span class="number">1</span>))</span><br><span class="line">  )</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">fib-iter</span> N cur less1 less2)</span><br><span class="line">  (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">=</span></span> <span class="number">1</span> N) <span class="number">1</span>)</span><br><span class="line">         ((<span class="name"><span class="builtin-name">=</span></span> <span class="number">2</span> N) <span class="number">1</span>)</span><br><span class="line">         ((<span class="name"><span class="builtin-name">=</span></span> cur N) (<span class="name">less1</span>))</span><br><span class="line">         (<span class="name"><span class="builtin-name">else</span></span> (<span class="name">fib-iter</span> N (<span class="name"><span class="builtin-name">+</span></span> cur <span class="number">1</span>) (<span class="name"><span class="builtin-name">+</span></span> less1 less2) less1)</span><br><span class="line">         )</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>

<h4 id="换零钱方式"><a href="#换零钱方式" class="headerlink" title="换零钱方式"></a>换零钱方式</h4><p>这个会比较复杂一点。就是用递归的方法进行计算有多少种方式</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">first-denomination</span> kinds-of-conions)</span><br><span class="line">  (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">=</span></span> kinds-of-conins <span class="number">1</span>) <span class="number">1</span>)</span><br><span class="line">        ((<span class="name"><span class="builtin-name">=</span></span> kinds-of-conins <span class="number">2</span>) <span class="number">5</span>)</span><br><span class="line">        ((<span class="name"><span class="builtin-name">=</span></span> kinds-of-conins <span class="number">3</span>) <span class="number">10</span>)</span><br><span class="line">        ((<span class="name"><span class="builtin-name">=</span></span> kinds-of-conins <span class="number">4</span>) <span class="number">25</span>)</span><br><span class="line">        ((<span class="name"><span class="builtin-name">=</span></span> kinds-of-conins <span class="number">5</span>) <span class="number">50</span>)</span><br><span class="line">  )</span><br><span class="line">)</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">count-change</span> amount)</span><br><span class="line">  (<span class="name">cc</span> amount <span class="number">5</span>))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">cc</span> amount kinds-of-conions)</span><br><span class="line">  (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">=</span></span> <span class="number">0</span> amount) <span class="number">1</span>)</span><br><span class="line">        ((<span class="name"><span class="builtin-name">or</span></span> (<span class="name"><span class="builtin-name">&lt;</span></span> amount <span class="number">0</span>) (<span class="name"><span class="builtin-name">=</span></span> kinds-of-conions <span class="number">0</span>)) <span class="number">0</span>)</span><br><span class="line">        (<span class="name"><span class="builtin-name">else</span></span> ( (<span class="name"><span class="builtin-name">+</span></span> (<span class="name">cc</span> amount (<span class="name"><span class="builtin-name">-</span></span> kinds-of-conions <span class="number">1</span>))</span><br><span class="line">                 (<span class="name">cc</span> (<span class="name"><span class="builtin-name">-</span></span> amount </span><br><span class="line">                        (<span class="name">first-denomination</span> kinds-of-conions))</span><br><span class="line">                     )</span><br><span class="line">                   )</span><br><span class="line">                )</span><br><span class="line">              )</span><br><span class="line">        )  	</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>

<p>下面是比较好理解的Java的方式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">int</span>[] arrange = &#123;<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;;</span><br><span class="line">       cal(arrange, <span class="number">50</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">cal</span><span class="params">(<span class="keyword">int</span>[] arrange, <span class="keyword">int</span> money)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (money == <span class="number">0</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">"50 cent "</span> + arrange[<span class="number">0</span>] + <span class="string">" 25 cent "</span> + arrange[<span class="number">1</span>] + <span class="string">" 10 cent "</span> + arrange[<span class="number">2</span>] + <span class="string">" 5 cent "</span> + arrange[<span class="number">3</span>] + <span class="string">" 1 cent"</span> + arrange[<span class="number">4</span>]);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (money &gt;= <span class="number">50</span>) &#123;</span><br><span class="line">            arrange[<span class="number">0</span>] += <span class="number">1</span>;</span><br><span class="line">            cal(arrange, money - <span class="number">50</span>);</span><br><span class="line">            arrange[<span class="number">0</span>] -= <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (money &gt;= <span class="number">25</span>) &#123;</span><br><span class="line">            arrange[<span class="number">1</span>] += <span class="number">1</span>;</span><br><span class="line">            cal (arrange, money - <span class="number">25</span>);</span><br><span class="line">            arrange[<span class="number">1</span>] -= <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (money &gt;= <span class="number">10</span>) &#123;</span><br><span class="line">            arrange[<span class="number">2</span>] += <span class="number">1</span>;</span><br><span class="line">            cal(arrange, money - <span class="number">10</span>);</span><br><span class="line">            arrange[<span class="number">2</span>] -= <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (money &gt;= <span class="number">5</span>) &#123;</span><br><span class="line">            arrange[<span class="number">3</span>] += <span class="number">1</span>;</span><br><span class="line">            cal(arrange, money -<span class="number">5</span>);</span><br><span class="line">            arrange[<span class="number">3</span>] -= <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (money &gt;= <span class="number">1</span>) &#123;</span><br><span class="line">            arrange[<span class="number">4</span>] += <span class="number">1</span>;</span><br><span class="line">            cal(arrange, money - <span class="number">1</span>);</span><br><span class="line">            arrange[<span class="number">4</span>] -= <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="练习-1-11"><a href="#练习-1-11" class="headerlink" title="练习 1.11"></a>练习 1.11</h4><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">fun-iter</span> n cur a b c)</span><br><span class="line">  (<span class="name"><span class="builtin-name">cond</span></span> (((<span class="name"><span class="builtin-name">=</span></span> n <span class="number">1</span>) <span class="number">1</span>)</span><br><span class="line">         ((<span class="name"><span class="builtin-name">=</span></span> n <span class="number">2</span>) <span class="number">2</span>)</span><br><span class="line">         ((<span class="name"><span class="builtin-name">=</span></span> n <span class="number">3</span>) <span class="number">3</span>)</span><br><span class="line">         ((<span class="name"><span class="builtin-name">=</span></span> n cur) a)</span><br><span class="line">         (<span class="name"><span class="builtin-name">else</span></span> (<span class="name">fun-iter</span> n (<span class="name"><span class="builtin-name">+</span></span> cur <span class="number">1</span>) (<span class="name"><span class="builtin-name">+</span></span> (<span class="name"><span class="builtin-name">*</span></span> a <span class="number">3</span>) (<span class="name"><span class="builtin-name">*</span></span> b <span class="number">2</span>) c) a b)</span><br><span class="line">        )</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">func</span> n)</span><br><span class="line">  (<span class="name">fun-iter</span> n <span class="number">3</span> <span class="number">3</span> <span class="number">2</span> <span class="number">1</span>)</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>

<h4 id="练习-1-12"><a href="#练习-1-12" class="headerlink" title="练习 1.12"></a>练习 1.12</h4><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">pascal</span> row col)</span><br><span class="line">  cond ( (<span class="name"><span class="builtin-name">&gt;</span></span> col row) (<span class="name">error</span> <span class="string">"unvalid col value"</span>)</span><br><span class="line">         ((<span class="name"><span class="builtin-name">or</span></span> (<span class="name"><span class="builtin-name">=</span></span> col <span class="number">0</span>) (<span class="name"><span class="builtin-name">=</span></span> col row)) <span class="number">1</span>)</span><br><span class="line">         (<span class="name"><span class="builtin-name">+</span></span> pascal((<span class="name"><span class="builtin-name">-</span></span> row <span class="number">1</span>) col) pascal((<span class="name"><span class="builtin-name">-</span></span> row <span class="number">1</span>) (<span class="name"><span class="builtin-name">+</span></span> col <span class="number">1</span>)))</span><br><span class="line">        )</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>

<p>这样的效率会很慢</p>
<p>由帕斯卡三角形（杨辉三角形）的公式可得 ${row \choose col}= \frac {row!} {col!(row−col)!}$</p>
<blockquote>
<p> 杨辉三角就是 $(x+1)^n$ 的系数的值 </p>
<p>单就3项而言 $\frac {n(n-1)} {2!}$  =&gt; $ \frac {n(n-1)(n-2)(n-3)…} {(n-k)!k!}$ =&gt; 这个值等价于 $\frac {n!} {k! (n-k)!}$</p>
<p>在二项式的展开中 除了第一项和最后一项 每一项中都会有n，根据素数的定义，素数的因数只有1和它本身，所以后在二项式展开的2到n-1 项中的n都不会被整除，会被保留。</p>
<p>所以在n是素数的情况下<strong>从第2项到n-1项的值都是n的倍数</strong></p>
<p>所以<strong>检查素数的方法</strong></p>
<p>求$(x+1)^n$展开式从第2到n-1项</p>
</blockquote>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">factorial</span> n)</span><br><span class="line">    (<span class="name">fact-iter</span> <span class="number">1</span> <span class="number">1</span> n))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">fact-iter</span> p b e)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span>  (<span class="name"><span class="builtin-name">&gt;</span></span> b e) </span><br><span class="line">       p</span><br><span class="line">       (<span class="name">fact-iter</span> (<span class="name"><span class="builtin-name">*</span></span> p b)(<span class="name"><span class="builtin-name">+</span></span> b <span class="number">1</span>) e))</span><br><span class="line">)</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">pascal</span> row col)</span><br><span class="line">  (<span class="name"><span class="builtin-name">/</span></span> (<span class="name">factorial</span> row) (<span class="name"><span class="builtin-name">*</span></span> (<span class="name">factorial</span> col) (<span class="name">factorial</span> (<span class="name"><span class="builtin-name">-</span></span> row col)))</span><br></pre></td></tr></table></figure>

<h4 id="更相减损术"><a href="#更相减损术" class="headerlink" title="更相减损术"></a>更相减损术</h4><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">gcb</span> a b)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">=</span></span> <span class="number">0</span> b) a ( gcb b (<span class="name"><span class="builtin-name">remainder</span></span> a b) )</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>

<h4 id="实例-1-2-6-素数检测"><a href="#实例-1-2-6-素数检测" class="headerlink" title="实例 1.2.6 素数检测"></a>实例 1.2.6 素数检测</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(define (devides? a b) </span><br><span class="line">	(&#x3D; (remainder a b) 0)</span><br><span class="line">(define (smallest-divisor n)</span><br><span class="line">	(find-divisor n 2))</span><br><span class="line">	</span><br><span class="line">(define (find-devisor n b)</span><br><span class="line">	(conds ((&gt; (square b) n)) n)</span><br><span class="line">		((devides? n b) b)</span><br><span class="line">		(else (find-deversior n (+ b 1)) </span><br><span class="line">	)</span><br></pre></td></tr></table></figure>

<h4 id="费马小定理"><a href="#费马小定理" class="headerlink" title="费马小定理"></a>费马小定理</h4><p>先说结论当n为素数的时候 $(a^n-a)mod(n) = 0$ 进一步的 </p>
<p>$a^nmod(n) = a$  </p>
<p>=&gt;  </p>
<p> $a^{n-1}mod(n)=1$ </p>
<p>人们通常把这样的式子写作</p>
<p>$a^{n-1} \equiv 1 (mod \ n)$</p>
<p>证明</p>
<ol>
<li>首先我们根据二项式定理能证明，当n为素数的时候 $((a + 1) ^ n - 1 - a^n )mod (n) = 0$</li>
<li>将费马小定理和二项式定理进行加和 $(a + 1) ^ n - 1 - a^n  + a^n-a$</li>
<li>整理一下 得到 $((a+1)^n - (a+1))$  </li>
<li>发现整理后的结果是 费马小定理的 n + 1 项。 已知二项式定理成立， 其结果能被n整除，若费马小定理的n项成立，即结果能被n整除，通过上式可知， 费马小定理的第 n+1 项必然成立</li>
<li>那么通过数学归纳法，我们去求当a为的0时候，那么 $(0^n-0)$ 的值。 0能被任何素数整除</li>
<li>所以费马小定理成立</li>
</ol>
<p><strong>注意</strong> 费马小定理是证明素数的充分不必要条件，比方说561 = 17 * 3 * 11. 但是 561 复合费马小定理的公式</p>
<p>换个表述方式我们定义$\phi(n)$ 为1～n中和n互质的数，我们可以得到 $a^{\phi(n)} = 1 (mod \ n)$，这个就是欧拉函数</p>
<h4 id="欧拉函数"><a href="#欧拉函数" class="headerlink" title="欧拉函数"></a>欧拉函数</h4><p>$a^{\phi(n)} = 1 (mod \ n)$</p>
<p>$\phi(n)$表示在1～n中和n互质的数</p>
<p>几个常用的定理</p>
<ol>
<li>当n和m互质</li>
</ol>
<p>$\phi(nm) = \phi(n) * \phi(m)$</p>
<ol start="2">
<li><p>当p为质数</p>
<p>$\phi(p) = p - 1$</p>
</li>
<li><p>当n为奇数的时候</p>
<p>$\phi(2 * n) = \phi(n)$</p>
</li>
<li><p>当 $n = p ^k$的时候</p>
<p>$\phi(n) = p^k * (1-\frac {1} {p}) = p^k - p^{k-1}$</p>
</li>
</ol>
<p><a href="https://www.cnblogs.com/henry-1202/p/10246196.html" target="_blank" rel="noopener">其他性质</a></p>
<p>题目</p>
<p>求$3^{83}$最后两位的值</p>
<p>​    根据欧拉公式$a^{\phi(n)} = 1 (mod \ n)$</p>
<p>$\phi(100) = \phi(4)\phi(25)=(2^2-2)*(5^2-5)=40$</p>
<p>$3^{83} = 3^3 * 3^{80} = 3^3 * (3 ^{\phi(100)})^2\equiv 3^3 = 27$</p>
<p><a href="https://zhuanlan.zhihu.com/p/35060143" target="_blank" rel="noopener">凶残小姐姐的知乎介绍</a></p>
<h2 id="用高阶函数抽象"><a href="#用高阶函数抽象" class="headerlink" title="用高阶函数抽象"></a>用高阶函数抽象</h2><h3 id="过程作为参数"><a href="#过程作为参数" class="headerlink" title="过程作为参数"></a>过程作为参数</h3><p>例子1</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">sum-cubes</span> a b)</span><br><span class="line">  	(<span class="name"><span class="builtin-name">if</span></span> ((<span class="name">a</span> &gt; b) <span class="number">0</span>)</span><br><span class="line">        (<span class="name"><span class="builtin-name">+</span></span> (<span class="name">cube</span> a) (<span class="name">sum-cubes</span> (<span class="name"><span class="builtin-name">+</span></span> <span class="number">1</span> a) b))</span><br><span class="line">    )</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>

<p>例子2</p>
<p>$$\sum_{n 0\to\infty }{\frac{1}{(1+4<em>n)(3+4</em>n)}} = {\frac {\pi} {8}}$$</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">pi-sum</span> a b)</span><br><span class="line">  	(<span class="name"><span class="builtin-name">if</span></span> ( (<span class="name"><span class="builtin-name">&gt;</span></span> a b) <span class="number">0</span>)</span><br><span class="line">        (<span class="name"><span class="builtin-name">else</span></span> (<span class="name"><span class="builtin-name">+</span></span>(<span class="name"><span class="builtin-name">/</span></span> <span class="number">1</span> (<span class="name"><span class="builtin-name">+</span></span> <span class="number">1</span> (<span class="name"><span class="builtin-name">*</span></span> <span class="number">4</span> n)))))</span><br><span class="line">    )</span><br><span class="line"> )</span><br></pre></td></tr></table></figure>

<p>我们可以填充下面模板中的各空位，产生出上面的各个过程：</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">&lt;name&gt;</span> a b)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (</span><br><span class="line">       ((<span class="name"><span class="builtin-name">&gt;</span></span> a b) <span class="number">0</span>)</span><br><span class="line">       (<span class="name"><span class="builtin-name">+</span></span> (<span class="name">&lt;term&gt;</span> a)</span><br><span class="line">          (<span class="name">&lt;name&gt;</span> (<span class="name">&lt;next&gt;</span> a) b)</span><br><span class="line">      )</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>

<p>转换一下</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">sum</span> term a next b)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> ((<span class="name"><span class="builtin-name">&gt;</span></span> a b) <span class="number">0</span>)</span><br><span class="line">      (<span class="name"><span class="builtin-name">else</span></span> (<span class="name"><span class="builtin-name">+</span></span> (<span class="name">term</span> a) </span><br><span class="line">               (<span class="name">sum</span> term (<span class="name">next</span> a) next b)))</span><br><span class="line"></span><br><span class="line">)</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">inc</span> n) (<span class="name"><span class="builtin-name">+</span></span> n <span class="number">1</span>))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">sum-cube</span> a b)</span><br><span class="line">  (<span class="name">sum</span> cube a inc b))</span><br></pre></td></tr></table></figure>

<p>相当于把过程作为参数传入</p>
<blockquote>
<p>然而，即使在数值计算过程中，如果将过程限制为只能以数作为参数，那么会严重的限制我们抽象的能力。经常有一些同样的程序设计模式能用于若干不同的过程，为了把这种模式描述为响应的概念吗，我们就需要构造出这样的过程，让他们以过程为参数。这类能操作过程的过程称为<strong>高阶过程</strong>。</p>
</blockquote>
<h3 id="用lambda构造过程"><a href="#用lambda构造过程" class="headerlink" title="用lambda构造过程"></a>用lambda构造过程</h3><p>如果不需要显示定义pi-term和pi-next，而是有一种方法直接刻画过程。我们可以通过引入一种lamdba特殊形式完成这种描述。</p>
<p>定义名称很麻烦我们利用lambda, 按照如下方式写出所需的东西</p>
<p>(lambda (x) (+ x 4))</p>
<p>(lambda表达式可用作组合式的运算符。 <strong>lambda表达式可做运算符</strong></p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">((<span class="name"><span class="builtin-name">lambda</span></span> (x y z) (<span class="name"><span class="builtin-name">+</span></span> x y (<span class="name">square</span> z))) <span class="number">1</span> <span class="number">2</span> <span class="number">3</span>)</span><br></pre></td></tr></table></figure>

<p>逻辑的过程是 </p>
<p>我们通过过程名称调用过程 -&gt; 将过程作为参数传入 -&gt; 将lambda （匿名函数） 作为参数传入</p>
<h3 id="用let创建局部变量"><a href="#用let创建局部变量" class="headerlink" title="用let创建局部变量"></a>用let创建局部变量</h3><p>$f(x,y) = x(1+xy)^2+y(1-y) + (1+xy)(1-y)$</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">f</span> x y)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">f-helper</span> a b) </span><br><span class="line">    (<span class="name"><span class="builtin-name">+</span></span> (<span class="name"><span class="builtin-name">*</span></span> x square a) (<span class="name"><span class="builtin-name">*</span></span> y b) (<span class="name"><span class="builtin-name">*</span></span> a b))</span><br><span class="line">  )</span><br><span class="line">  (<span class="name">f-helper</span> </span><br><span class="line">   	(<span class="name"><span class="builtin-name">+</span></span> <span class="number">1</span> (<span class="name"><span class="builtin-name">*</span></span> x y))</span><br><span class="line">   	(<span class="name"><span class="builtin-name">-</span></span> <span class="number">1</span> y)</span><br><span class="line">   )</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>如果使用lambda的话</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">f</span> x y)</span><br><span class="line">  ((<span class="name"><span class="builtin-name">lambda</span></span> (a b) </span><br><span class="line">    (<span class="name"><span class="builtin-name">+</span></span> (<span class="name"><span class="builtin-name">*</span></span> x square a) </span><br><span class="line">       (<span class="name"><span class="builtin-name">*</span></span> y b) </span><br><span class="line">       (<span class="name"><span class="builtin-name">*</span></span> a b)))</span><br><span class="line">   (<span class="name"><span class="builtin-name">+</span></span> <span class="number">1</span> (<span class="name"><span class="builtin-name">*</span></span> x y))</span><br><span class="line">   (<span class="name"><span class="builtin-name">-</span></span> <span class="number">1</span> y)</span><br><span class="line">  )</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>如果使用let的话</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">f</span> x y)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> (</span><br><span class="line">        (<span class="name">a</span> (<span class="name"><span class="builtin-name">+</span></span> <span class="number">1</span> (<span class="name"><span class="builtin-name">*</span></span> x y)))</span><br><span class="line">        (<span class="name">b</span> (<span class="name"><span class="builtin-name">-</span></span> <span class="number">1</span> y)))</span><br><span class="line">    (<span class="name"><span class="builtin-name">+</span></span> (<span class="name">x</span> (<span class="name">square</span> x))</span><br><span class="line">       (<span class="name"><span class="builtin-name">*</span></span> y b)</span><br><span class="line">       (<span class="name"><span class="builtin-name">*</span></span> a b)</span><br><span class="line">       )</span><br><span class="line">    )</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>

<p>let 表达式只是作为基础lambda表达式的语法外衣罢了</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://www.andrewchen1.top/2019/09/28/ASM4-%E6%96%B9%E6%B3%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="小夫">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小夫的笔记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/09/28/ASM4-%E6%96%B9%E6%B3%95/" class="post-title-link" itemprop="url">ASM4-方法</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2019-09-28 15:21:07 / Modified: 22:17:39" itemprop="dateCreated datePublished" datetime="2019-09-28T15:21:07+08:00">2019-09-28</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ASM4-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/" itemprop="url" rel="index"><span itemprop="name">ASM4 使用指南</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h1><h2 id="3-1-结构"><a href="#3-1-结构" class="headerlink" title="3.1 结构"></a>3.1 结构</h2><h3 id="3-1-1-执行模型"><a href="#3-1-1-执行模型" class="headerlink" title="3.1.1 执行模型"></a>3.1.1 执行模型</h3><p>每个线程都有自己的执行栈，栈由栈帧组成。每个帧表示一个方法调用。<strong>每次调用一个方法时，会将一个新栈帧push入当前线程的执行栈。当方法返回时，会讲这个帧从执行栈中弹出，执行过程在发出调用的方法中继续进行</strong>每一帧包括</p>
<ul>
<li>操作数栈</li>
<li>局部变量表</li>
<li>动态链接（DL）</li>
<li>方法返回</li>
</ul>
<p>局部变量表与操作数栈大小取决于方法的代码。</p>
<p><strong>在创建一个帧时会将其初始化，提供一个空栈，并用目标对象this(非静态方法)，以及该方法的参数来初始化局部变量。比如调用a.equals(b)将创建一个帧，它有一个空栈，前两个局部变量被初始化为a和b</strong></p>
<h3 id="3-1-2-字节代码指令"><a href="#3-1-2-字节代码指令" class="headerlink" title="3.1.2 字节代码指令"></a>3.1.2 字节代码指令</h3><p>字节代码指令由一个表示该指令的操作码和固定数目的参数组成</p>
<ul>
<li>操作码 是由一个无符号字节值，由助记符号标识。</li>
<li>参数时静态值，确定了精确的指令行为</li>
</ul>
<p>字节代码指令可以分为两类 </p>
<ol>
<li>一小组指令。设计用在局部变量表和操作数栈之间传送值</li>
<li>仅用于操作数栈：从栈中弹出一些值，根据这些值计算一个结果，并将它压回栈中</li>
</ol>
<p>ILOAD,LLOAD,FLOAD,DLOAD,ALOAD。 他们的参数必须是读取的局部变量的索引i。</p>
<ul>
<li>ILOAD 加载 boolean、byte、char、short、int局部变量</li>
<li>LLoad、FLoad、DLoad 分别用于记载long，float，double的值</li>
<li>ALoad 用于加载任意非基元值即对象和数组</li>
</ul>
<p>ISTORE, LSTORE,FSTORE, DSTORE, ASTORE 从操作数栈中弹出一个值，并且将它存储在由索引i指定的局部变量中</p>
<p>xLoad和xStore指令被赋入了类型。确保不会执行非法转换。实际上，将一个值存储在局部变量中，然后再以不同的类型加载它是非法的。比方说ISTORE 1ALOAD1 序列是非法的。但是向一个局部变量中存储一个值，而这个值的类型不同于该局部变量中存储的当前值，却是完全合法的。</p>
<ul>
<li><p>栈 </p>
<p><em>POP<em>弹出栈顶部的值，</em>DUP</em> 压入顶部，<em>SWAP</em>弹出两个值，并且按逆序压入他们</p>
</li>
<li><p>常量</p>
<p>这些指令在操作数栈压入一个常量值：ACONST_NULL 压入null，ICONST_0 压入int0， FCONST_0 压入0f，DCONST_0压入0d，BIPUSH b 压入字节值b，SIPUSH s 压入short值 s，LDC 压入任意int、float、long、double、String或者class 常量cst</p>
</li>
<li><p>算数与逻辑</p>
<p>这些指令从操作数栈弹出数值，合并他们，并将结果压入栈中。他们没有任何参数。xADD，xSUB，xMUL，xDIV和xREM。</p>
</li>
<li><p>类型变换</p>
<p>这些指令从栈中弹出一个值，将其转换为另一种类型，并将结果压入栈中。他们对应Java中的类型转换表达式。I2F，F2D，L2D等将数值由一种数值类型转换为另一种类型。CHECKCAST t将一个引用值类型转换为类型t</p>
</li>
<li><p>对象</p>
<p>这些指令用于创建对象、锁定他们、检测他们的类型，等等。 NEW type 指令将一个type类型的新对象压入栈中</p>
</li>
<li><p>字段</p>
<p>这些指令读或者写一个字段的值。GETFIELD ower name desc 弹出一个对象引用，并将name字段中的值压入栈中。PUTFIELD owner name desc 弹出一个值和一个对象引用，并且将这个值存储在它的name字段中。在这两种情况下，该对象都必须是owner类型，它的字段必须是desc类型。GETSTATIC和PUTSTATIC是类似的指令 </p>
</li>
<li><p>方法</p>
<p>这些指令调用一个方法或构造器。它们弹出值的个数等于其方法参数个数 + 1（用于目标对象），并压回方法调用的结果。 INVOKEVIRTUREAL owner name des调用在类owner中定义的name方法，其方法描述符为desc。INVOKESTATIC 用于静态方法，INVOKESPECIAL用于私有方法和构造器。INVOKDYNAMIC用于动态方法调用机制</p>
</li>
<li><p>数组</p>
<p>这些指令用于读写数组中的值。xALOAD指令弹出一个索引和一个数组，并压入此索引处数组元素的值。xASTORE指令弹出一个值，一个索引和一个数组，并将这个值存入在该数组的这一索引处。x可以为I（int）、L（long）、F（float）、D（double）、A（other）、B（byte）、C（char）、S（short）</p>
</li>
<li><p>跳转</p>
<p>这些指令无条件的或者在某一条件为真的时候跳转到任意指令。它们用于编译if、for、do、while、break、continue指令。IFEQ label 从栈中弹出一个int值，如果这个值是0，跳转到label指定的指令处。还有其他的指令IFNE、IFGE、TABLESWITCH、LOOKUPSWITCH 对应switch 指令</p>
</li>
<li><p>返回</p>
<p>RETURN用于返回void方法，xRETURN用于其他方法</p>
</li>
</ul>
<h3 id="3-1-3-举例说明"><a href="#3-1-3-举例说明" class="headerlink" title="3.1.3 举例说明"></a>3.1.3 举例说明</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Bean</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> f;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getF</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> f;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setF</span><span class="params">(<span class="keyword">int</span> f)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.f = f;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-1-3-1-getter"><a href="#3-1-3-1-getter" class="headerlink" title="3.1.3.1 getter"></a>3.1.3.1 getter</h4><p>getter的字节码为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ALOAD 0</span><br><span class="line">GETFIELD pkg&#x2F;Bean f I</span><br><span class="line">IRETURN</span><br></pre></td></tr></table></figure>

<p>读取局部变量0，（局部变量0在为这个方法调用创建帧期间被初始化为this），并且将这个值压入操作数栈中。</p>
<p>从操作数栈中弹出这个值，并且将这个对象的f字段压入栈中</p>
<p>从栈中弹出这个值，返回给调用者</p>
<h4 id="3-1-3-2-setter"><a href="#3-1-3-2-setter" class="headerlink" title="3.1.3.2 setter"></a>3.1.3.2 setter</h4><p>setter方法的字节码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ALOAD 0</span><br><span class="line">ILOAD 1</span><br><span class="line">SETFIELD pkg&#x2F;Bean f I</span><br><span class="line">RETURN</span><br></pre></td></tr></table></figure>

<p>读取局部变量0，（局部变量0在为这个方法调用创建帧期间被初始化为this），并且将这个值压入操作数栈中。</p>
<p>压入局部变量1</p>
<p>弹出这两个值，并将int值存储在被引用对象的f字段中。</p>
<p>销毁当前执行帧，并返回调用者。</p>
<h4 id="3-1-3-3-contractor"><a href="#3-1-3-3-contractor" class="headerlink" title="3.1.3.3 contractor"></a>3.1.3.3 contractor</h4><p>bean类有一个默认的构造函数，在没有定义的情况下是由编译器生成的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Bean() &#123;</span><br><span class="line">  <span class="keyword">super</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>构造函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ALOAD 1</span><br><span class="line">INVOKESPECIAL java&#x2F;lang&#x2F;Object &lt;init&gt; ()V</span><br><span class="line">RETURN</span><br></pre></td></tr></table></figure>

<p>读取局部变量0，（局部变量0在为这个方法调用创建帧期间被初始化为this），并且将这个值压入操作数栈中。</p>
<p>调用Object对象中定义的&lt;init&gt;方法</p>
<h4 id="3-1-3-4-复杂的使用"><a href="#3-1-3-4-复杂的使用" class="headerlink" title="3.1.3.4 复杂的使用"></a>3.1.3.4 复杂的使用</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkAndSetF</span><span class="params">(<span class="keyword">int</span> f)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (f &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.f = f;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ILOAD 1</span><br><span class="line">IFLT label</span><br><span class="line">ALOAD 0</span><br><span class="line">ILOAD 1</span><br><span class="line">PUTFIELD pkg&#x2F;Bean f I</span><br><span class="line">GOTO end</span><br><span class="line">label:</span><br><span class="line">	NEW java&#x2F;lang&#x2F;IllegalArgumentException</span><br><span class="line">	DUP</span><br><span class="line">	INVOKESPECIAL java&#x2F;lang&#x2F;IllegalArgumentException &lt;init&gt;()V</span><br><span class="line">	ATHROW</span><br><span class="line">end:</span><br><span class="line">	RETURN</span><br></pre></td></tr></table></figure>

<h4 id="3-1-3-5-异常处理器"><a href="#3-1-3-5-异常处理器" class="headerlink" title="3.1.3.5 异常处理器"></a>3.1.3.5 异常处理器</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sleep</span><span class="params">(<span class="keyword">long</span> d)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(d);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">TRYCATCHBLOCK try catch catch java&#x2F;lang&#x2F;InterrutedExcetion</span><br><span class="line">try:</span><br><span class="line">	LLOAD 0</span><br><span class="line">	INVOKESTATIC java&#x2F;lang&#x2F;Thread sleep(J)V</span><br><span class="line">	RETURN</span><br><span class="line">catch:</span><br><span class="line">	INVOKEVIRTUAL java&#x2F;lang&#x2F;InterruptedException printStackTrace ()V</span><br><span class="line">  RETURN</span><br></pre></td></tr></table></figure>

<p><strong>TRYCATCHBLOCK</strong>行制定了一个异常处理器， 覆盖了try和catch标记之间的范围，有一个开始于catch标记的处理器，用于处理一些异常，这些异常是InterruptedException的子类。如果在try和catch之间抛出了一个异常，栈将被清空，异常被压入这个空栈中，执行过程在catch中继续。</p>
<h4 id="3-1-3-6-帧"><a href="#3-1-3-6-帧" class="headerlink" title="3.1.3.6 帧"></a>3.1.3.6 帧</h4><p>除了字节码指令外，Java6或者更高的编译类中还包括一组栈映射帧，用于加快Java虚拟机中类验证过程的速度。<strong>它给出了就要执行某一特定字节码指令之前，每个局部变量槽和每个操作数栈槽总包含的值的类型</strong></p>
<p>为节省空间，已编译方法中没有为每个指令包含一个帧 它仅为那些应对跳转目标或者异常处理器的指令，或者跟在无条件跳转指令之后的指令创建帧。</p>
<p>在checkAndSetF 方法的情景中。仅存储两个帧 一个是用于NEW指令，另一个用于RETURN指令。因为它是GOTO指令的目标，还因为它跟在无条件跳转ATHROW指令后。</p>
<h2 id="3-2-接口和组件"><a href="#3-2-接口和组件" class="headerlink" title="3.2 接口和组件"></a>3.2 接口和组件</h2><p>用于生成和转换已编译方法的ASM api 是基于MethodVisitor抽象类的。它由ClassVisitor的visitMethod返回。这些方法必须按照以下顺序调用</p>
<p>visitAnntationDefault?</p>
<p>(visitAnnotation | visitParameterAnnotation | visitAttribute  )*</p>
<p>(visitCode</p>
<p> (visitTryCatchBlock | vistLabel | visitFrame | visitXxxInsn | visitLocalVariable | visitLineNumber) *</p>
<p>visitMaxs)?</p>
<p>visitEnd</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://www.andrewchen1.top/2019/09/21/ASM4-%E7%BB%93%E6%9E%84/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="小夫">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小夫的笔记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/09/21/ASM4-%E7%BB%93%E6%9E%84/" class="post-title-link" itemprop="url">ASM4-结构</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-09-21 15:53:12" itemprop="dateCreated datePublished" datetime="2019-09-21T15:53:12+08:00">2019-09-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-09-28 15:55:55" itemprop="dateModified" datetime="2019-09-28T15:55:55+08:00">2019-09-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ASM4-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/" itemprop="url" rel="index"><span itemprop="name">ASM4 使用指南</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="类"><a href="#类" class="headerlink" title="类"></a>类</h1><h2 id="2-1-类的结构"><a href="#2-1-类的结构" class="headerlink" title="2.1 类的结构"></a>2.1 类的结构</h2><h3 id="2-1-1-已编译类的整体结构"><a href="#2-1-1-已编译类的整体结构" class="headerlink" title="2.1.1 已编译类的整体结构"></a>2.1.1 已编译类的整体结构</h3><table>
<thead>
<tr>
<th>内容</th>
<th>子内容</th>
</tr>
</thead>
<tbody><tr>
<td>修饰符、名字、超类、接口</td>
<td></td>
</tr>
<tr>
<td>常量池：数值、字符串、类型常量</td>
<td></td>
</tr>
<tr>
<td>源文件名（可选）</td>
<td></td>
</tr>
<tr>
<td>封装的类引用</td>
<td></td>
</tr>
<tr>
<td>注释*</td>
<td></td>
</tr>
<tr>
<td>属性*</td>
<td></td>
</tr>
<tr>
<td>内部类*</td>
<td>名称</td>
</tr>
<tr>
<td>字段*</td>
<td>修饰符、名字、类型</td>
</tr>
<tr>
<td></td>
<td>注释</td>
</tr>
<tr>
<td></td>
<td>属性</td>
</tr>
<tr>
<td>方法*</td>
<td>修饰符、名字、返回类型、参数类型</td>
</tr>
<tr>
<td></td>
<td>注释</td>
</tr>
<tr>
<td></td>
<td>属性</td>
</tr>
<tr>
<td></td>
<td>编译后的代码</td>
</tr>
</tbody></table>
<p>* 表示0个到多个</p>
<h3 id="2-1-2-类型描述符"><a href="#2-1-2-类型描述符" class="headerlink" title="2.1.2 类型描述符"></a>2.1.2 类型描述符</h3><table>
<thead>
<tr>
<th>Java类型</th>
<th>类型表述符</th>
</tr>
</thead>
<tbody><tr>
<td>boolean</td>
<td>Z</td>
</tr>
<tr>
<td>char</td>
<td>C</td>
</tr>
<tr>
<td>byte</td>
<td>B</td>
</tr>
<tr>
<td>short</td>
<td>S</td>
</tr>
<tr>
<td>int</td>
<td>I</td>
</tr>
<tr>
<td>float</td>
<td>F</td>
</tr>
<tr>
<td>long</td>
<td>J</td>
</tr>
<tr>
<td>Double</td>
<td>D</td>
</tr>
<tr>
<td>Object</td>
<td>Ljava/lang/Object;</td>
</tr>
<tr>
<td>int[]</td>
<td>[I</td>
</tr>
<tr>
<td>Object[][]</td>
<td>[[Ljava/lang/Object;</td>
</tr>
</tbody></table>
<h3 id="2-1-3-类型描述符"><a href="#2-1-3-类型描述符" class="headerlink" title="2.1.3 类型描述符"></a>2.1.3 类型描述符</h3><table>
<thead>
<tr>
<th>源文件中的方法声明</th>
<th>方法描述符</th>
</tr>
</thead>
<tbody><tr>
<td>Void main (int i, float f)</td>
<td>(IF)V</td>
</tr>
<tr>
<td>int m(Object o)</td>
<td>(Ljava.lang.Object;)I</td>
</tr>
<tr>
<td>int[] m (int i, String s)</td>
<td>(ILjava/lang/String;)I[</td>
</tr>
<tr>
<td>Object m(int[] i)</td>
<td>([I)Ljava/lang/Object;</td>
</tr>
</tbody></table>
<h2 id="2-2-接口和组件"><a href="#2-2-接口和组件" class="headerlink" title="2.2 接口和组件"></a>2.2 接口和组件</h2><h3 id="2-2-1-介绍"><a href="#2-2-1-介绍" class="headerlink" title="2.2.1 介绍"></a>2.2.1 介绍</h3><p>ClassVistor 就是就是个模板 我们对类的处理都通过这个<strong>模板</strong>生成的类来进行</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassVisitor</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">ClassVistor</span><span class="params">(<span class="keyword">int</span> api)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">ClassVistor</span><span class="params">(<span class="keyword">int</span> api, ClassVistor cv)</span></span>;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  	* verison 版本信息</span></span><br><span class="line"><span class="comment">  	* access 权限信息 </span></span><br><span class="line"><span class="comment">  	* name 类的名称</span></span><br><span class="line"><span class="comment">  	* signature 泛化</span></span><br><span class="line"><span class="comment">  	* superName 父类信息</span></span><br><span class="line"><span class="comment">  	* interface 接口信息</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(<span class="keyword">int</span> version, <span class="keyword">int</span> access, String name, String signature, String superName, String[] interface)</span></span>;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitSource</span><span class="params">(String source, String debug)</span></span>;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitOuterClass</span><span class="params">(String ower, String name, String desc)</span></span>;</span><br><span class="line">  </span><br><span class="line">  <span class="function">AnnotationVisitor <span class="title">visitAnnotation</span><span class="params">(String desc, Boolean visible)</span></span>;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitAttribute</span><span class="params">(Attribute attr)</span></span>;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitInnerClass</span><span class="params">(String name, String outerName, String innerName, <span class="keyword">int</span> access)</span></span>;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> FieldVisitor <span class="title">visitField</span><span class="params">(<span class="keyword">int</span> access, String name, String desc, String signature, Object value)</span></span>;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> MethodVisitor <span class="title">visitorMethod</span><span class="params">(<span class="keyword">int</span> access, String name, String desc, String signature, String[] exceptions)</span></span>;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">visitEnd</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在上面的类中返回了 <strong>AnnotationVisitor</strong>, <strong>FieldVisitor</strong>, <strong>MethodVisitor</strong>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">FieldVisitor</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">FieldVisitor</span><span class="params">(<span class="keyword">int</span> api)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">FieldVisitor</span><span class="params">(<span class="keyword">int</span> api, FieldVisitor fv)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> AnnotationVisitor <span class="title">visitorAnnotation</span><span class="params">(String desc, <span class="keyword">boolean</span> visible)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitAttribute</span><span class="params">(Attribute attr)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitEnd</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ClassVisitor 类的方法必须按照以下的顺序进行调用</p>
<p>visit visitSourcce? visitOuterClass? (visitAnnotation | visitAttribute)*  (visitInnerClass | visitField | visitMethod) * visitEnd</p>
<p>ASM提供了三个基于ClassVisitor API的核心组件，用于变化和生成类</p>
<ul>
<li><strong>ClassReader <em>*分析以字节数组形式给出的已编译类，并针对其accept方法参数中传送的ClassVisitor实例， 调用相应的visit</em></strong>方法。这个类可以看作是一个时间生成器。</li>
<li><strong>ClassWriter</strong> 是ClassVisitor抽象类的一个子类，它直接以二进行形式生成编译后的类。</li>
<li><strong>ClassVisitor</strong> 类将它收到的所有方法调用都委托为另一个ClassVistor类。可以看作是事件筛选器。</li>
</ul>
<h3 id="2-2-2-分析类"><a href="#2-2-2-分析类" class="headerlink" title="2.2.2 分析类"></a>2.2.2 分析类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">ClassReader classReader = <span class="keyword">new</span> ClassReader(<span class="string">"java.lang.Runnable"</span>);</span><br><span class="line">classReader.accept(<span class="keyword">new</span> ClassVisitor(ASM4) &#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(<span class="keyword">int</span> version, <span class="keyword">int</span> access, String name, String signature, String superName, String[] interface)</span> </span>&#123;</span><br><span class="line">    System.out.println(name + <span class="string">"extends"</span> + superName + <span class="string">"&#123; "</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitSource</span><span class="params">(String source, String debug)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitOuterClass</span><span class="params">(String ower, String name, String desc)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function">AnnotationVisitor <span class="title">visitAnnotation</span><span class="params">(String desc, Boolean visible)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitAttribute</span><span class="params">(Attribute attr)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitInnerClass</span><span class="params">(String name, String outerName, String innerName, <span class="keyword">int</span> access)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> FieldVisitor <span class="title">visitField</span><span class="params">(<span class="keyword">int</span> access, String name, String desc, String signature, Object value)</span> </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">" "</span> + desc + <span class="string">" "</span> + name);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> MethodVisitor <span class="title">visitorMethod</span><span class="params">(<span class="keyword">int</span> access, String name, String desc, String signature, String[] exceptions)</span> </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">" "</span> + name + desc);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">visitEnd</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Sysgtem.out.println(<span class="string">"&#125;"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<p>获得的结果是</p>
<p>java/lang/Runnable extends java/lang/Object {</p>
<p>​    run()V</p>
<p>}</p>
<h3 id="2-2-3-生成类"><a href="#2-2-3-生成类" class="headerlink" title="2.2.3 生成类"></a>2.2.3 生成类</h3><p>如果我们想生成类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> pkg;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Comparable</span> <span class="keyword">extends</span> <span class="title">Mesurable</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> LESS = -<span class="number">1</span>;</span><br><span class="line">  <span class="keyword">int</span> EQUAL = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">int</span> GRATER = <span class="number">1</span>;</span><br><span class="line">  <span class="function"><span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(Object o)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们可以对ClassVisitor进行6次方法调用来生成它：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ClassWriter cw = <span class="keyword">new</span> ClassWriter();</span><br><span class="line">cw.visitor(V1_5, ACC_PUBLIC + ACC_ABSTRACT + ACC_INTERFACE, <span class="string">"pkg/Comparable"</span>, <span class="keyword">null</span>, <span class="string">"java/lang/Object"</span>);</span><br><span class="line">cw.visitField(ACC_PUBLIC + ACC_FINAL + ACC_STATIC, <span class="string">"LESS"</span>, <span class="string">"I"</span>, <span class="keyword">null</span>, <span class="keyword">new</span> Integer(-<span class="number">1</span>)).visitEnd();</span><br><span class="line">cw.visitField(ACC_PUBLIC + ACC_FINAL + ACC_STATIC, <span class="string">"EQUAL"</span>, <span class="string">"I"</span>, <span class="keyword">null</span>, <span class="keyword">new</span> Integer(<span class="number">0</span>)).visitEnd();</span><br><span class="line">cw.visitField(ACC_PUBLIC + ACC_FINAL + ACC_STATIC, <span class="string">"GRATER"</span>, <span class="string">"I"</span>, <span class="keyword">null</span>, <span class="keyword">new</span> Integer(<span class="number">1</span>)).visitEnd();</span><br><span class="line"></span><br><span class="line">cw.visitField(ACC_PUBLIC + ACC_ABSTRACT, <span class="string">"compareTo"</span>, <span class="string">"(Ljava/lang/Object;)I"</span>, <span class="keyword">null</span>, <span class="keyword">null</span>).visitEnd();</span><br><span class="line"></span><br><span class="line">cw.visitEnd();</span><br><span class="line"></span><br><span class="line"><span class="keyword">byte</span>[] b = cw.toByteArray();</span><br></pre></td></tr></table></figure>

<p>产生的中间码可以被clasLoader</p>
<p>new ClassLoad().defineClass(“pkg.Comparable”, b, 0, b.length);</p>
<p>或者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StubClassLoader</span> <span class="title">extend</span> <span class="title">ClassLoader</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> Class <span class="title">findClass</span><span class="params">(BeanDenefication bd)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (bd.isProxyed) &#123;</span><br><span class="line">      ClassWriter cw = <span class="keyword">new</span> ClassWriter();</span><br><span class="line">      <span class="keyword">byte</span>[] b = cw.getByteArray();</span><br><span class="line">      <span class="keyword">return</span> defineClass(name, b, <span class="number">0</span>, b.length);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      bd.getClass();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个可能是Spring 生成类的方式</p>
<h3 id="2-2-4转换类"><a href="#2-2-4转换类" class="headerlink" title="2.2.4转换类"></a>2.2.4转换类</h3> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChangeVersionAdapter</span> <span class="keyword">extends</span> <span class="title">ClassVisitor</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">ChangeVisionAdapter</span><span class="params">(ClassVisitor cv)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span> (ASM4, cv);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(<span class="keyword">int</span> version, <span class="keyword">int</span> access, String name,</span></span></span><br><span class="line"><span class="function"><span class="params">                   String signature, String superName, String[] interfaces)</span> </span>&#123;</span><br><span class="line">    cv.visit(V1_6, access, name, signature, superName, interfaces);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> (InputStream inputStream = <span class="keyword">this</span>.getClass().getClassLoader().getResourceAsStream(<span class="string">"path"</span>)) &#123;</span><br><span class="line">            <span class="keyword">int</span> size = inputStream.available();</span><br><span class="line">            <span class="keyword">byte</span>[] bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[size];</span><br><span class="line">            inputStream.read(bytes);</span><br><span class="line">            ClassReader classReader = <span class="keyword">new</span> ClassReader(bytes);</span><br><span class="line">            ClassWriter classWriter = <span class="keyword">new</span> ClassWriter(classReader , <span class="number">0</span>);</span><br><span class="line">            ClassVisitor classVisitor = <span class="keyword">new</span> ChangeVersionAdapter(classWriter);</span><br><span class="line">            classReader.accept(classVisitor, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-5-移除类成员"><a href="#2-2-5-移除类成员" class="headerlink" title="2.2.5 移除类成员"></a>2.2.5 移除类成员</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RemoveMethodAdapter</span> <span class="keyword">extends</span> <span class="title">ClassVisitor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String mName;</span><br><span class="line">    <span class="keyword">private</span> String mDesc;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RemoveMethodAdapter</span><span class="params">(ClassVisitor cv, String mName, String mDesc)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(ASM4, cv);</span><br><span class="line">        <span class="keyword">this</span>.mName = mName;</span><br><span class="line">        <span class="keyword">this</span>.mDesc = mDesc;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MethodVisitor <span class="title">visitMethod</span><span class="params">(<span class="keyword">int</span> access, String name, String desc, String signature, String[] exceptions)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (name.equals(mName) &amp;&amp; desc.equals(mDesc)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> cv.visitMethod(access, name, desc, signature, exceptions);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-6-增加类成员"><a href="#2-2-6-增加类成员" class="headerlink" title="2.2.6 增加类成员"></a>2.2.6 增加类成员</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AddFieldAdapter</span> <span class="keyword">extends</span> <span class="title">ClassVisitor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> fAcc;</span><br><span class="line">    <span class="keyword">private</span> String fName;</span><br><span class="line">    <span class="keyword">private</span> String fDesc;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> isFieldPresent;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AddFieldAdapter</span><span class="params">(ClassVisitor cv, <span class="keyword">int</span> fAcc, String fName, String fDesc)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(ASM4, cv);</span><br><span class="line">        <span class="keyword">this</span>.fAcc = fAcc;</span><br><span class="line">        <span class="keyword">this</span>.fName = fName;</span><br><span class="line">        <span class="keyword">this</span>.fDesc = fDesc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> FieldVisitor <span class="title">fieldVisitor</span><span class="params">(<span class="keyword">int</span> access, String name, String desc, String signature, Object value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (name.equals(fName)) &#123;</span><br><span class="line">            isFieldPresent = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> cv.visitField(access, name, desc, signature, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitEnd</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (! isFieldPresent) &#123;</span><br><span class="line">            FieldVisitor fv = cv.visitField(fAcc, fName, fDesc, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">if</span> ( fv != <span class="keyword">null</span>) &#123;</span><br><span class="line">                fv.visitEnd();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        cv.visitEnd();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们只是检测一下我们我们要添加的字段是不是存在的， 如果不存在的话，我们进行字段的添加</p>
<h3 id="2-2-7-转化链"><a href="#2-2-7-转化链" class="headerlink" title="2.2.7 转化链"></a>2.2.7 转化链</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MultiClassAdapter</span> <span class="keyword">extends</span> <span class="title">ClassVisitor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> ClassVisitor[] cvs;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MultiClassAdapter</span><span class="params">(ClassVisitor[] cvs)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(ASM4);</span><br><span class="line">        <span class="keyword">this</span>.cvs = cvs;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(<span class="keyword">int</span> version, <span class="keyword">int</span> access, String name, String signature, String superName, String[] interfaces)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (ClassVisitor cv : cvs) &#123;</span><br><span class="line">            cv.visit(version, access, name, signature, superName, interfaces);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-8-TraceClassVisitor-amp-CheckClassAdapter"><a href="#2-2-8-TraceClassVisitor-amp-CheckClassAdapter" class="headerlink" title="2.2.8 TraceClassVisitor &amp; CheckClassAdapter"></a>2.2.8 TraceClassVisitor &amp; CheckClassAdapter</h3><ul>
<li><p>TraceClassVisitor</p>
<p>以获得关于实际所生成内容的一个可读轨迹</p>
</li>
<li><p>CheckClassAdapter</p>
<p>验证其对方法的调用顺序是否恰当，参数是否有效，然后才会委托给一下个防蚊器。当发生错误时，会抛出IllegaStateException或IllegalArgumentException</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ClassWriter cw = <span class="keyword">new</span> ClassWriter(<span class="number">0</span>);</span><br><span class="line">TraceClassVisitor tcv = <span class="keyword">new</span> TraceClassVisitor(cw, printWriter);</span><br><span class="line">CheckClassA</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://www.andrewchen1.top/2019/09/13/spring%E6%8F%AD%E7%A7%98-%E6%8E%8C%E7%AE%A1%E5%A4%A7%E5%B1%80%E7%9A%84Ioc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="小夫">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小夫的笔记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/09/13/spring%E6%8F%AD%E7%A7%98-%E6%8E%8C%E7%AE%A1%E5%A4%A7%E5%B1%80%E7%9A%84Ioc/" class="post-title-link" itemprop="url">spring揭秘-掌管大局的Ioc</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2019-09-13 21:37:32 / Modified: 21:39:51" itemprop="dateCreated datePublished" datetime="2019-09-13T21:37:32+08:00">2019-09-13</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/spring%E6%8F%AD%E7%A7%98/" itemprop="url" rel="index"><span itemprop="name">spring揭秘</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="掌管大局的Ioc"><a href="#掌管大局的Ioc" class="headerlink" title="掌管大局的Ioc"></a>掌管大局的Ioc</h1><h2 id="主要职责"><a href="#主要职责" class="headerlink" title="主要职责"></a>主要职责</h2><ol>
<li>业务对象的构建管理</li>
<li>业务对象之间的依赖绑定</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://www.andrewchen1.top/2019/08/24/Java-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E7%82%B9%E6%95%B4%E7%90%864/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="小夫">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小夫的笔记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/08/24/Java-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E7%82%B9%E6%95%B4%E7%90%864/" class="post-title-link" itemprop="url">Java-基础知识点整理4</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-08-24 13:50:41" itemprop="dateCreated datePublished" datetime="2019-08-24T13:50:41+08:00">2019-08-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-09-28 13:07:55" itemprop="dateModified" datetime="2019-09-28T13:07:55+08:00">2019-09-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" itemprop="url" rel="index"><span itemprop="name">Java基础知识</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Java异常分类和处理"><a href="#Java异常分类和处理" class="headerlink" title="Java异常分类和处理"></a>Java异常分类和处理</h1><h2 id="Java注解"><a href="#Java注解" class="headerlink" title="Java注解"></a>Java注解</h2><ul>
<li><p>@Target</p>
<p>表示这个注解使用的范围</p>
</li>
<li><p>@Retention</p>
<p>表示这个注解的存活时间范围。比方说是</p>
<blockquote>
<p>作者：RednaxelaFX</p>
<p>链接：<a href="https://www.zhihu.com/question/60835139/answer/180750670" target="_blank" rel="noopener">https://www.zhihu.com/question/60835139/answer/180750670</a></p>
<p>来源：知乎</p>
<p>著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</p>
<p>RetentionPolicy.SOURCE：只在本编译单元的编译过程中保留，并不写入Class文件中。这种注解主要用于在本编译单元（这里一个Java源码文件可以看作一个编译单元）内触发注解处理器（annotation processor）的相关处理，例如说可以让注解处理器相应地生成一些代码，或者是让注解处理器做一些额外的类型检查(@Override)，等等。</p>
<p>RetentionPolicy.CLASS：在编译的过程中保留并且会写入Class文件中，但是JVM在加载类的时候不需要将其加载为运行时可见的（反射可见）的注解。这里很重要的一点是编译多个Java文件时的情况：假如要编译A.java源码文件和B.class文件，其中A类依赖B类，并且B类上有些注解希望让A.java编译时能看到，那么B.class里就必须要持有这些注解信息才行。</p>
<ul>
<li>同时我们可能不需要让它在运行时对反射可见（例如说为了减少运行时元数据的大小之类），所以会选择CLASS而不是RUNTIME。</li>
</ul>
<p>RetentionPolicy.RUNTIME：在编译过程中保留，会写入Class文件，并且JVM加载类的时候也会将其加载为反射可见的注解。这就不用多说了，例如说Spring的依赖注入就会在运行时通过扫描类上的注解来决定注入啥。</p>
</blockquote>
</li>
<li><p>@Document </p>
<p>描述javadoc</p>
</li>
<li><p>@Inherited  </p>
<p>如果值是是的话 被标注了这个注解的类的子类也会有这个注解</p>
</li>
</ul>
<h1 id="Spring-原理"><a href="#Spring-原理" class="headerlink" title="Spring 原理"></a>Spring 原理</h1><h2 id="Spring-Bean-生命周期"><a href="#Spring-Bean-生命周期" class="headerlink" title="Spring Bean 生命周期"></a>Spring Bean 生命周期</h2><p><img src="http://img.andrewchen1.top/181453414212066.png" alt="生命周期"></p>
<p><img src="http://img.andrewchen1.top/181454040628981.png" alt="生命周期"></p>
<p><a href="https://www.cnblogs.com/zrtqsk/p/3735273.html" target="_blank" rel="noopener">生命周期</a></p>
<h2 id="Bean的定义"><a href="#Bean的定义" class="headerlink" title="Bean的定义"></a>Bean的定义</h2><p>可以通过在xml中定义Bean</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span> = <span class="string">""</span> <span class="attr">class</span> = <span class="string">""</span>&gt;</span></span><br><span class="line">  	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"name"</span> <span class="attr">value</span>=<span class="string">"root"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"$&#123;jdbc.password]&#125;"</span></span></span><br><span class="line">  &lt;/bean&gt;</span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>或者在类上面使用@Component的注解。 通过ComponentScan的方式要找到相关的类。插一句 ComponentScan的怎么做</p>
<ul>
<li><p>ComponentScanAnnotationParser#parse</p>
</li>
<li><p>ClassPathBeanDefinitionScanner#doScan</p>
</li>
<li><p>ClassPathScanningCandidateComponentProvider#findCandidateComponents</p>
<p>​    要做的事情就是读取Class的文件流，通过JVM中class的定义获得实现的接口等的信息，然后把这些信息写入到beandefinition 对象中。</p>
<ul>
<li><p>将class path 中的.替换成/</p>
</li>
<li><p>拼装成 classpath<em>:经过转换的basePackage地址 +  **/\</em>.class</p>
</li>
<li><p>MetadataReaderFactory#getMetadataReader</p>
</li>
<li><p>SimpleMetadataReader#getMetadataReader</p>
</li>
<li><p>ClassReader#accept </p>
<p>这里涉及到ASM的内容<a href="http://img.andrewchen1.top/ASM4%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97.pdf" target="_blank" rel="noopener">ASM4使用指南</a> 根据规范编译后的class文件的格式是固定的，我们可以根据ASM工具来从class文件中读取我们关心的信息。</p>
</li>
</ul>
<p>返回含有父类、实现接口、注解等信息的包装类(RootBeanDefination)</p>
</li>
</ul>
<h2 id="从DefaultListableBeanFactory-管中窥豹-看Bean的生命流程"><a href="#从DefaultListableBeanFactory-管中窥豹-看Bean的生命流程" class="headerlink" title="从DefaultListableBeanFactory 管中窥豹 看Bean的生命流程"></a>从DefaultListableBeanFactory 管中窥豹 看Bean的生命流程</h2><p>因为BeanFactory是懒加载的 ，当我们调用getBean()的时候，会</p>
<ul>
<li><p>AbstractBeanFactory#doGetBean(inal String name, final Class<T> requiredType, final Object[] args, boolean typeCheckOnly)</p>
<ul>
<li><p>transformedBeanName</p>
<p>得到bean Name，入参的beanName中如果有&amp;符号 截取到最后一个&amp;开始到结束的子字符串作为bean name</p>
</li>
<li><p>DefaultSingletonBeanRegistry#getSingleton</p>
<h4 id="背景知识-Bean的循环依赖和解决"><a href="#背景知识-Bean的循环依赖和解决" class="headerlink" title="背景知识 Bean的循环依赖和解决"></a>背景知识 Bean的循环依赖和解决</h4><p>以下内容来自 <a href="https://blog.csdn.net/u010853261/article/details/77940767" target="_blank" rel="noopener">Spring-bean的循环依赖以及解决方式</a></p>
<p> Spring的单例对象的初始化主要分为三步：</p>
<ul>
<li><p>create Bean Instance 实例化</p>
</li>
<li><p>popluate Bean 填充属性</p>
</li>
<li><p>Initalize Bean 初始化</p>
<p>在Spring容器整个生命周期内，有且只有一个对象，所以很容易想到这个对象应该存在Cache中，Spring为了解决单例的循环依赖问题，使用了<strong>三级缓存</strong>。</p>
<p>DefaultSingletonBeanRegistry.class</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Cache of singleton objects: bean name --&gt; bean instance */</span></span><br><span class="line"><span class="comment">// 单例对象的cache</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Object&gt; singletonObjects = <span class="keyword">new</span> ConcurrentHashMap&lt;String, Object&gt;(<span class="number">256</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Cache of singleton factories: bean name --&gt; ObjectFactory */</span></span><br><span class="line"><span class="comment">// 单例工厂的cache </span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, ObjectFactory&lt;?&gt;&gt; singletonFactories = <span class="keyword">new</span> HashMap&lt;String, ObjectFactory&lt;?&gt;&gt;(<span class="number">16</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Cache of early singleton objects: bean name --&gt; bean instance */</span></span><br><span class="line"><span class="comment">// 提前曝光的单例对象</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Object&gt; earlySingletonObjects = <span class="keyword">new</span> HashMap&lt;String, Object&gt;(<span class="number">16</span>);</span><br></pre></td></tr></table></figure>

<p>尝试从cache中获得对象</p>
<p>DefaultSingletonBeanRegistry#getSingleton</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">getSingleton</span><span class="params">(String beanName, <span class="keyword">boolean</span> allowEarlyReference)</span> </span>&#123;</span><br><span class="line">    Object singletonObject = <span class="keyword">this</span>.singletonObjects.get(beanName);</span><br><span class="line">    <span class="keyword">if</span> (singletonObject == <span class="keyword">null</span> &amp;&amp; isSingletonCurrentlyInCreation(beanName)) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>.singletonObjects) &#123;</span><br><span class="line">            singletonObject = <span class="keyword">this</span>.earlySingletonObjects.get(beanName);</span><br><span class="line">            <span class="keyword">if</span> (singletonObject == <span class="keyword">null</span> &amp;&amp; allowEarlyReference) &#123;</span><br><span class="line">                ObjectFactory&lt;?&gt; singletonFactory = <span class="keyword">this</span>.singletonFactories.get(beanName);</span><br><span class="line">                <span class="keyword">if</span> (singletonFactory != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    singletonObject = singletonFactory.getObject();</span><br><span class="line">                    <span class="keyword">this</span>.earlySingletonObjects.put(beanName, singletonObject);</span><br><span class="line">                    <span class="keyword">this</span>.singletonFactories.remove(beanName);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (singletonObject != NULL_OBJECT ? singletonObject : <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的代码需要解释两个参数：</p>
<p>isSingletonCurrentlyInCreation()判断当前单例bean是否正在创建中，也就是没有初始化完成(比如A的构造器依赖了B对象所以得先去创建B对象， 或则在A的populateBean过程中依赖了B对象，得先去创建B对象，这时的A就是处于创建中的状态。)<br>allowEarlyReference 是否允许从singletonFactories中通过getObject拿到对象<br>分析getSingleton()的整个过程，Spring首先从一级缓存singletonObjects中获取。如果获取不到，并且对象正在创建中，就再从二级缓存earlySingletonObjects中获取。如果还是获取不到且允许singletonFactories通过getObject()获取，就从三级缓存singletonFactory.getObject()(三级缓存)获取，如果获取到了则：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.earlySingletonObjects.put(beanName, singletonObject);</span><br><span class="line"><span class="keyword">this</span>.singletonFactories.remove(beanName);</span><br></pre></td></tr></table></figure>


</li>
</ul>
</li>
</ul>
</li>
</ul>
<pre><code> 从singletonFactories中移除，并放入earlySingletonObjects中。其实也就是从三级缓存移动到了二级缓存。

 从上面三级缓存的分析，我们可以知道，Spring解决循环依赖的诀窍就在于singletonFactories这个三级cache。这个cache的类型是ObjectFactory，定义如下：

 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ObjectFactory</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function">T <span class="title">getObject</span><span class="params">()</span> <span class="keyword">throws</span> BeansException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


 这个接口在下面被引用

 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">addSingletonFactory</span><span class="params">(String beanName, ObjectFactory&lt;?&gt; singletonFactory)</span> </span>&#123;</span><br><span class="line">    Assert.notNull(singletonFactory, <span class="string">"Singleton factory must not be null"</span>);</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>.singletonObjects) &#123;</span><br><span class="line">        <span class="keyword">if</span> (! <span class="keyword">this</span>.singletonObjects.containsKey(beanName)) &#123;</span><br><span class="line">            <span class="keyword">this</span>.singletonFactories.put(beanName, singletonFactory);</span><br><span class="line">            <span class="keyword">this</span>.earlySingletonObjects.remove(beanName);</span><br><span class="line">            <span class="keyword">this</span>.registeredSingletons.add(beanName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

 这里就是解决循环依赖的关键，这段代码发生在createBeanInstance之后，也就是说单例对象此时已经被创建出来(调用了构造器)。这个对象已经被生产出来了，虽然还不完美（还没有进行初始化的第二步和第三步），但是已经能被人认出来了（根据对象引用能定位到堆中的对象），所以Spring此时将这个对象提前曝光出来让大家认识，让大家使用。



 这样做有什么好处呢？让我们来分析一下“A的某个field或者setter依赖了B的实例对象，同时B的某个field或者setter依赖了A的实例对象”这种循环依赖的情况。A首先完成了初始化的第一步，并且将自己提前曝光到singletonFactories中，此时进行初始化的第二步，发现自己依赖对象B，此时就尝试去get(B)，发现B还没有被create，所以走create流程，B在初始化第一步的时候发现自己依赖了对象A，于是尝试get(A)，尝试一级缓存singletonObjects(肯定没有，因为A还没初始化完全)，尝试二级缓存earlySingletonObjects（也没有），尝试三级缓存singletonFactories，由于A通过ObjectFactory将自己提前曝光了，所以B能够通过ObjectFactory.getObject拿到A对象(虽然A还没有初始化完全，但是总比没有好呀)，B拿到A对象后顺利完成了初始化阶段1、2、3，完全初始化之后将自己放入到一级缓存singletonObjects中。此时返回A中，A此时能拿到B的对象顺利完成自己的初始化阶段2、3，最终A也完成了初始化，进去了一级缓存singletonObjects中，而且更加幸运的是，由于B拿到了A的对象引用，所以B现在hold住的A对象完成了初始化。

 知道了这个原理时候，肯定就知道为啥Spring不能解决“A的构造方法中依赖了B的实例对象，同时B的构造方法中依赖了A的实例对象”这类问题了！因为加入singletonFactories三级缓存的前提是执行了构造器，所以构造器的循环依赖没法解决。

 参考 http://www.jianshu.com/p/6c359768b1dc

如果在三级缓存中找到了 再通过BeanName做一次判断 判断这个 我们想要的是这个bean 还是生成这个bean的factory。 在最初的时候我们是把bean name 给处理了一次的 看上面的**transformedBeanName** 说明。</code></pre><ul>
<li><p>getObjectForBeanInstance</p>
<p>在之前我们在cache中找到了bean。但是这个bean可能是factoryBean。 我们需要通过工厂Bean 获得产品Bean</p>
<p>AbstractBeanFactory#getObjectForBeanInstance</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">getObjectForBeanInstance</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">			Object beanInstance, String name, String beanName, RootBeanDefinition mbd)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Don't let calling code try to dereference the factory if the bean isn't a factory.</span></span><br><span class="line">  <span class="comment">// 因为在尝试获得bean的使用bean的名字是去掉&amp;符号的。&amp;表示工厂bean。 但是根据这个beanName获取道的并不是FactoryBean的 抛错</span></span><br><span class="line">		<span class="keyword">if</span> (BeanFactoryUtils.isFactoryDereference(name) &amp;&amp; !(beanInstance <span class="keyword">instanceof</span> FactoryBean)) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> BeanIsNotAFactoryException(transformedBeanName(name), beanInstance.getClass());</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Now we have the bean instance, which may be a normal bean or a FactoryBean.</span></span><br><span class="line">		<span class="comment">// If it's a FactoryBean, we use it to create a bean instance, unless the</span></span><br><span class="line">		<span class="comment">// caller actually wants a reference to the factory.</span></span><br><span class="line">  <span class="comment">// 相当于 ! beanInstance instanceof FactoryBean &amp;&amp; ! BeanFactoryUtils.isFactoryDereference(name) 确定 名字并不是BeanFactory类型的 且 得到的类并不是工厂类型的， return bean</span></span><br><span class="line">		<span class="keyword">if</span> (!(beanInstance <span class="keyword">instanceof</span> FactoryBean) || BeanFactoryUtils.isFactoryDereference(name)) &#123;</span><br><span class="line">			<span class="keyword">return</span> beanInstance;</span><br><span class="line">		&#125;</span><br><span class="line"><span class="comment">// 否则就是通过BeanFactory构建Bean</span></span><br><span class="line">		Object object = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">if</span> (mbd == <span class="keyword">null</span>) &#123;</span><br><span class="line">			object = getCachedObjectForFactoryBean(beanName);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (object == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="comment">// Return bean instance from factory.</span></span><br><span class="line">			FactoryBean&lt;?&gt; factory = (FactoryBean&lt;?&gt;) beanInstance;</span><br><span class="line">			<span class="comment">// Caches object obtained from FactoryBean if it is a singleton.</span></span><br><span class="line">			<span class="keyword">if</span> (mbd == <span class="keyword">null</span> &amp;&amp; containsBeanDefinition(beanName)) &#123;</span><br><span class="line">				mbd = getMergedLocalBeanDefinition(beanName);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">boolean</span> synthetic = (mbd != <span class="keyword">null</span> &amp;&amp; mbd.isSynthetic());</span><br><span class="line">			object = getObjectFromFactoryBean(factory, beanName, !synthetic);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> object;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>通过getObjectFromFactoryBean获得Bean，在factoryBeanObjectCache中是不是已经存在Bean了，如果存在直接返回， 如果没有 通过BeanFactory 构建，构建的Bean还是要AbstractAutowireCapableBeanFactory#applyBeanPostProcessorsAfterInitialization 进行组装。 同时根据factory bean 是否是isSingleton的来确定是否要加入到factoryBeanObjectCache中</p>
<p>FactoryBeanRegistrySupport#getObjectFromFactoryBean</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Obtain an object to expose from the given FactoryBean.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> factory the FactoryBean instance</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> beanName the name of the bean</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> shouldPostProcess whether the bean is subject to post-processing</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> the object obtained from the FactoryBean</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> BeanCreationException if FactoryBean object creation failed</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@see</span> org.springframework.beans.factory.FactoryBean#getObject()</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> Object <span class="title">getObjectFromFactoryBean</span><span class="params">(FactoryBean&lt;?&gt; factory, String beanName, <span class="keyword">boolean</span> shouldPostProcess)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (factory.isSingleton() &amp;&amp; containsSingleton(beanName)) &#123;</span><br><span class="line">			<span class="keyword">synchronized</span> (getSingletonMutex()) &#123;</span><br><span class="line">				Object object = <span class="keyword">this</span>.factoryBeanObjectCache.get(beanName);</span><br><span class="line">				<span class="keyword">if</span> (object == <span class="keyword">null</span>) &#123;</span><br><span class="line">					object = doGetObjectFromFactoryBean(factory, beanName);</span><br><span class="line">					<span class="comment">// Only post-process and store if not put there already during getObject() call above</span></span><br><span class="line">					<span class="comment">// (e.g. because of circular reference processing triggered by custom getBean calls)</span></span><br><span class="line">					Object alreadyThere = <span class="keyword">this</span>.factoryBeanObjectCache.get(beanName);</span><br><span class="line">					<span class="keyword">if</span> (alreadyThere != <span class="keyword">null</span>) &#123;</span><br><span class="line">						object = alreadyThere;</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">else</span> &#123;</span><br><span class="line">						<span class="keyword">if</span> (object != <span class="keyword">null</span> &amp;&amp; shouldPostProcess) &#123;</span><br><span class="line">							<span class="keyword">if</span> (isSingletonCurrentlyInCreation(beanName)) &#123;</span><br><span class="line">								<span class="comment">// Temporarily return non-post-processed object, not storing it yet..</span></span><br><span class="line">								<span class="keyword">return</span> object;</span><br><span class="line">							&#125;</span><br><span class="line">							beforeSingletonCreation(beanName);</span><br><span class="line">							<span class="keyword">try</span> &#123;</span><br><span class="line">								object = postProcessObjectFromFactoryBean(object, beanName);</span><br><span class="line">							&#125;</span><br><span class="line">							<span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">								<span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(beanName,</span><br><span class="line">										<span class="string">"Post-processing of FactoryBean's singleton object failed"</span>, ex);</span><br><span class="line">							&#125;</span><br><span class="line">							<span class="keyword">finally</span> &#123;</span><br><span class="line">								afterSingletonCreation(beanName);</span><br><span class="line">							&#125;</span><br><span class="line">						&#125;</span><br><span class="line">						<span class="keyword">if</span> (containsSingleton(beanName)) &#123;</span><br><span class="line">							<span class="keyword">this</span>.factoryBeanObjectCache.put(beanName, (object != <span class="keyword">null</span> ? object : NULL_OBJECT));</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">return</span> (object != NULL_OBJECT ? object : <span class="keyword">null</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			Object object = doGetObjectFromFactoryBean(factory, beanName);</span><br><span class="line">			<span class="keyword">if</span> (object != <span class="keyword">null</span> &amp;&amp; shouldPostProcess) &#123;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					object = postProcessObjectFromFactoryBean(object, beanName);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">					<span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(beanName, <span class="string">"Post-processing of FactoryBean's object failed"</span>, ex);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> object;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果这个Bean在这之前没有创建过，那么要进行创建。</p>
<ul>
<li><p>如果这个Beanfactroy有parent Bean factory的话。 那么通过委托的方式看能不能得到bean</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Check if bean definition exists in this factory.</span></span><br><span class="line">			BeanFactory parentBeanFactory = getParentBeanFactory();</span><br><span class="line">			<span class="keyword">if</span> (parentBeanFactory != <span class="keyword">null</span> &amp;&amp; !containsBeanDefinition(beanName)) &#123;</span><br><span class="line">				<span class="comment">// Not found -&gt; check parent.</span></span><br><span class="line">				String nameToLookup = originalBeanName(name);</span><br><span class="line">				<span class="keyword">if</span> (args != <span class="keyword">null</span>) &#123;</span><br><span class="line">					<span class="comment">// Delegation to parent with explicit args.</span></span><br><span class="line">					<span class="keyword">return</span> (T) parentBeanFactory.getBean(nameToLookup, args);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span> &#123;</span><br><span class="line">					<span class="comment">// No args -&gt; delegate to standard getBean method.</span></span><br><span class="line">					<span class="keyword">return</span> parentBeanFactory.getBean(nameToLookup, requiredType);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>保证创建这个bean的时候，它构造方法中的Bean都已经创建好了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">String[] dependsOn = mbd.getDependsOn();</span><br><span class="line">				<span class="keyword">if</span> (dependsOn != <span class="keyword">null</span>) &#123;</span><br><span class="line">					<span class="keyword">for</span> (String dep : dependsOn) &#123;</span><br><span class="line">						<span class="keyword">if</span> (isDependent(beanName, dep)) &#123;</span><br><span class="line">							<span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(mbd.getResourceDescription(), beanName,</span><br><span class="line">									<span class="string">"Circular depends-on relationship between '"</span> + beanName + <span class="string">"' and '"</span> + dep + <span class="string">"'"</span>);</span><br><span class="line">						&#125;</span><br><span class="line">						registerDependentBean(dep, beanName);</span><br><span class="line">						<span class="keyword">try</span> &#123;</span><br><span class="line">							getBean(dep);</span><br><span class="line">						&#125;</span><br><span class="line">						<span class="keyword">catch</span> (NoSuchBeanDefinitionException ex) &#123;</span><br><span class="line">							<span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(mbd.getResourceDescription(), beanName,</span><br><span class="line">									<span class="string">"'"</span> + beanName + <span class="string">"' depends on missing bean '"</span> + dep + <span class="string">"'"</span>, ex);</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>DefaultSingletonBeanRegistry#isDependent</p>
<p>通过递归的方式进行调用 保证这个Bean 构造方法中所依赖的Bean，Bean 构造方法中所依赖的Bean的构造方法中（如果这个Bean还没有被创建的话）所依赖的Bean… 都已经准备好了，否则报错💥</p>
<p>*<em>这里就显示了通过构造方法，依赖注入的方式创建Bean，Bean之间不允许互相依赖，但是通过setter的方式，依赖注入Bean， Bean之间是允许 *</em></p>
<p>特别说明</p>
<p><strong>举个简单例子：例如 B 依赖了 A，则 dependentBeanMap 缓存中应该存放一对映射：其中 key 为 A，value 为含有 B 的 Set；而 dependenciesForBeanMap 缓存中也应该存放一对映射：其中 key 为：B，value 为含有 A 的 Set。</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">      <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isDependent</span><span class="params">(String beanName, String dependentBeanName, Set&lt;String&gt; alreadySeen)</span> </span>&#123;</span><br><span class="line">      		<span class="keyword">if</span> (alreadySeen != <span class="keyword">null</span> &amp;&amp; alreadySeen.contains(beanName)) &#123;</span><br><span class="line">      			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">      		&#125;</span><br><span class="line">      		String canonicalName = canonicalName(beanName);</span><br><span class="line">      		Set&lt;String&gt; dependentBeans = <span class="keyword">this</span>.dependentBeanMap.get(canonicalName);</span><br><span class="line">      		<span class="keyword">if</span> (dependentBeans == <span class="keyword">null</span>) &#123;</span><br><span class="line">      			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">      		&#125;</span><br><span class="line">      		<span class="keyword">if</span> (dependentBeans.contains(dependentBeanName)) &#123;</span><br><span class="line">      			<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">      		&#125;</span><br><span class="line">      		<span class="keyword">for</span> (String transitiveDependency : dependentBeans) &#123;</span><br><span class="line">      			<span class="keyword">if</span> (alreadySeen == <span class="keyword">null</span>) &#123;</span><br><span class="line">      				alreadySeen = <span class="keyword">new</span> HashSet&lt;String&gt;();</span><br><span class="line">      			&#125;</span><br><span class="line">      			alreadySeen.add(beanName);</span><br><span class="line">      			<span class="keyword">if</span> (isDependent(transitiveDependency, dependentBeanName, alreadySeen)) &#123;</span><br><span class="line">      				<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">      			&#125;</span><br><span class="line">&#125;</span><br><span class="line">      		<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">      	&#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
</li>
</ul>
</li>
</ul>
<ol start="2">
<li><p>BeanFactoryPostProcessor</p>
<p>将${}中的值做替换成*.properties中的内容</p>
</li>
<li><p>InstantiationAwareBeanPostProcessor#postProcessBeforInstantiation </p>
<p>Instantiation [ɪnstænʃɪ’eɪʃən] </p>
<p>执行Bean的构造器</p>
</li>
<li><p>InstantiationAwareBeanPostProcessor#postProcessPropertyValue</p>
<p>根据xml中的定义设置property的值</p>
</li>
<li><p>ApplicationContextAwareProcessor#postProcessBeforeInitialization</p>
<p>ApplicationContextAwareProcessor是BeanPostProcessor的一个实现 在内部会调用invokeAwareInterfaces方法 里面会有很多的if 来判断这个类是不是特定的aware类型，比方说</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (object <span class="keyword">instanceof</span> ApplicationContextAware) &#123;</span><br><span class="line">  ((ApplicationContextAware) object).setApplicationContext();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://www.andrewchen1.top/2019/08/11/Java-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E7%82%B9%E6%95%B4%E7%90%863/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="小夫">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小夫的笔记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/08/11/Java-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E7%82%B9%E6%95%B4%E7%90%863/" class="post-title-link" itemprop="url">Java 基础知识点整理3</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-08-11 16:21:13" itemprop="dateCreated datePublished" datetime="2019-08-11T16:21:13+08:00">2019-08-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-09-07 14:53:16" itemprop="dateModified" datetime="2019-09-07T14:53:16+08:00">2019-09-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" itemprop="url" rel="index"><span itemprop="name">Java基础知识</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Java-多线程并发"><a href="#Java-多线程并发" class="headerlink" title="Java 多线程并发"></a>Java 多线程并发</h1><h2 id="线程的创建方式"><a href="#线程的创建方式" class="headerlink" title="线程的创建方式"></a>线程的创建方式</h2><ol>
<li><p>继承Thread类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Thread thread = <span class="keyword">new</span> Thread() &#123;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> 	</span>&#123;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>实现Runnable接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Runnable run = <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//do something</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line">Thread t = <span class="keyword">new</span> Thread(run);</span><br></pre></td></tr></table></figure>
</li>
<li><p>ExecutorService Callable<E>, Future</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ExecutorSrevice threadPool = Executors.cachedThreadPool();</span><br><span class="line">Future f = threadPool.submit(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">  <span class="comment">// 各种run任务的描述</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="线程池"><a href="#线程池" class="headerlink" title="线程池"></a>线程池</h2><ol>
<li><p>newCachedThreadPool</p>
<p>调用execute将重用之前构造的线程(如果线程可用) 如果现有的线程没有可用的,则创建一个新线程并添加到线程池中.<strong>终止并从缓存中移除</strong>那些已有60s未被使用的线程</p>
</li>
<li><p>newFixedThreadPool</p>
</li>
<li><p>newScheduledThreadPool</p>
</li>
<li><p>newSingleThreadExecutor</p>
</li>
</ol>
<h3 id="线程的结束"><a href="#线程的结束" class="headerlink" title="线程的结束"></a>线程的结束</h3><h4 id="定义一个退出标志"><a href="#定义一个退出标志" class="headerlink" title="定义一个退出标志"></a>定义一个退出标志</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Thread t = <span class="keyword">new</span> Thread() &#123;</span><br><span class="line">  <span class="keyword">volatile</span> Boolean stop;</span><br><span class="line">  </span><br><span class="line">  &#123;</span><br><span class="line">    stop = <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (! stop) &#123;</span><br><span class="line">      </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ol>
<h4 id="interrupted"><a href="#interrupted" class="headerlink" title="interrupted"></a>interrupted</h4><p>   用interrupted 有两种方法</p>
<ol>
<li><p>当线程处于blocked的状态的时候.我们调用该线程的interrupt()方法会抛出InterruptedException</p>
</li>
<li><p>在线程在处于非blocked状态的时候 去判断它的中断标示,这个方法会和方法1同时使用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Thread t = <span class="keyword">new</span> Thread() &#123;</span><br><span class="line">  <span class="keyword">volatile</span> Boolean stop;</span><br><span class="line">  </span><br><span class="line">  &#123;</span><br><span class="line">    stop = <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (! stop &amp;&amp; ! isInterrupted()) &#123;</span><br><span class="line">      <span class="comment">// do something</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h4 id="sleep-和wait之间的区别"><a href="#sleep-和wait之间的区别" class="headerlink" title="sleep 和wait之间的区别"></a>sleep 和wait之间的区别</h4><p>​        - sleep 是属于Thread 的方法. wait是属于object的方法.</p>
<p>​        - sleep 是让渡cpu时间. 而wait是让渡出临界资源的控制权</p>
<h2 id="Java-锁"><a href="#Java-锁" class="headerlink" title="Java 锁"></a>Java 锁</h2><h3 id="悲观锁"><a href="#悲观锁" class="headerlink" title="悲观锁"></a>悲观锁</h3><p>悲观锁可以叫做独占锁, 在得到这个资源之后到让渡出这个资源之前其他的事物都不能访问这个资源.</p>
<h3 id="乐观锁"><a href="#乐观锁" class="headerlink" title="乐观锁"></a>乐观锁</h3><p>相对于悲观锁, 乐观锁认为在很大的程度下这个资源都不会发生变化 所以也没有必要进行独占(大家都可以访问), 在准备对这个资源进行修改的时候要去验证一下这个资源是不是发生变化了, 如果发生变化了就放弃修改, 如果是没有发生变化,那就修改它. (Compare And Swap)</p>
<h3 id="自旋锁"><a href="#自旋锁" class="headerlink" title="自旋锁"></a>自旋锁</h3><ul>
<li>自旋</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">long offset = Unsafe.getUnsafe().objectFieldOffset(Stuednt.class.getDeclaredField("name"));</span><br><span class="line">Object o;</span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">    v = Unsafe.getUnsafe().getObjectVolatile(o, offset); </span><br><span class="line">&#125; <span class="keyword">while</span> (! Unsafe.getUnsafe().compareAndSwapObject(student, offset, v,<span class="string">"new name"</span>);)</span><br></pre></td></tr></table></figure>

<ul>
<li>如果持有锁的线程能在很短的时间内释放锁资源, 那么那些等待竞争锁的线程就不需要做内核态和用户态之间的切换进入阻塞挂起状态,只要等一等就好了.</li>
</ul>
<h2 id="Synchronized"><a href="#Synchronized" class="headerlink" title="Synchronized"></a>Synchronized</h2><h3 id="作用范围"><a href="#作用范围" class="headerlink" title="作用范围"></a>作用范围</h3><ul>
<li>作用方法 </li>
<li>作用静态方法</li>
<li>sychronized(something) </li>
</ul>
<h3 id="核心组件"><a href="#核心组件" class="headerlink" title="核心组件"></a>核心组件</h3><p><a href="https://www.cnblogs.com/lykm02/p/4516777.html" target="_blank" rel="noopener">详细说明 </a></p>
<ul>
<li><p>contention list</p>
<p>竞争队列 所有请求锁的线程首先放在这个竞争队列中</p>
</li>
<li><p>entry list</p>
<p>Contention list zhong 有资格称为候选资源的线程被移动到这个竞争队列中</p>
</li>
<li><p>wait set</p>
<p>调用wait的线程在这个队列中</p>
</li>
<li><p>OnDeck </p>
<p>任意时刻最多只能有一个线程正在竞争锁,该线程被称为OnDeck</p>
</li>
<li><p>Owner</p>
<p>获得锁的进程称为Owener</p>
</li>
<li><p>! Owener</p>
<p>释放锁的线程    </p>
</li>
</ul>
<blockquote>
<p><img src="http://img.andrewchen1.top/20121109112521_220.jpg" alt="队列说明"></p>
<ul>
<li><p><strong>ContentionList</strong> <strong>虚拟队列</strong></p>
<p>ContentionList 并不是一个真正的Queue，而只是一个虚拟队列，原因在于ContentionList是由Node及其next指 针逻辑构成，并不存在一个Queue的数据结构。ContentionList是一个后进先出（LIFO）的队列，每次新加入Node时都会在队头进行， 通过CAS改变第一个节点的的指针为新增节点，同时设置新增节点的next指向后续节点，而取得操作则发生在队尾。显然，该结构其实是个Lock- Free的队列。 </p>
<p>因为只有Owner线程才能从队尾取元素，也即线程出列操作无争用，当然也就避免了CAS的ABA问题。</p>
<p><img src="http://img.andrewchen1.top/20121109112521_981.jpg" alt="LIFO"></p>
</li>
<li><p>EntryList</p>
<p>EntryList与ContentionList逻辑上同属等待队列，ContentionList会被线程并发访问，为了降低对 ContentionList队尾的争用，而建立EntryList。Owner线程在unlock时会从ContentionList中迁移线程到 EntryList，并会指定EntryList中的某个线程（一般为Head）为Ready（OnDeck）线程。Owner线程并不是把锁传递给 OnDeck线程，只是把竞争锁的权利交给OnDeck，OnDeck线程需要重新竞争锁。这样做虽然牺牲了一定的公平性，但极大的提高了整体吞吐量，在 Hotspot中把OnDeck的选择行为称之为“竞争切换”。 </p>
<p>OnDeck线程获得锁后即变为owner线程，无法获得锁则会依然留在EntryList中，考虑到公平性，在EntryList中的位置不 发生变化（依然在队头）。如果Owner线程被wait方法阻塞，则转移到WaitSet队列；如果在某个时刻被notify/notifyAll唤醒， 则再次转移到EntryList。</p>
</li>
<li><p>自旋锁</p>
<p>那些处于ContetionList、EntryList、WaitSet中的线程均处于阻塞状态，阻塞操作由操作系统完成（在Linxu下通 过pthread_mutex_lock函数）<em>LockSupport.park() LockSupport.unPark()</em>。线程被阻塞后便进入内核（Linux）调度状态，这个会导致系统在用户态与内核态之间来回切换，严重影响 锁的性能 </p>
<p>缓解上述问题的办法便是自旋，其原理是：当发生争用时，若Owner线程能在很短的时间内释放锁，则那些正在争用线程可以稍微等一等（自旋）， 在Owner线程释放锁后，争用线程可能会立即得到锁，从而避免了系统阻塞。但Owner运行的时间可能会超出了临界值，争用线程自旋一段时间后还是无法 获得锁，这时争用线程则会停止自旋进入阻塞状态（后退）。基本思路就是自旋，不成功再阻塞，尽量降低阻塞的可能性，这对那些执行时间很短的代码块来说有非 常重要的性能提高。自旋锁有个更贴切的名字：自旋-指数后退锁，也即复合锁。很显然，自旋在多处理器上才有意义。 </p>
<p>还有个问题是，线程自旋时做些啥？其实啥都不做，可以执行几次for循环，可以执行几条空的汇编指令，目的是占着CPU不放，等待获取锁的机 会。所以说，自旋是把双刃剑，如果旋的时间过长会影响整体性能，时间过短又达不到延迟阻塞的目的。显然，自旋的周期选择显得非常重要，但这与操作系统、硬 件体系、系统的负载等诸多场景相关，很难选择，如果选择不当，不但性能得不到提高，可能还会下降，因此大家普遍认为自旋锁不具有扩展性。 </p>
<p>自旋优化策略 </p>
<p>对自旋锁周期的选择上，HotSpot认为最佳时间应是一个线程上下文切换的时间，但目前并没有做到。经过调查，目前只是通过汇编暂停了几个CPU周期，除了自旋周期选择，HotSpot还进行许多其他的自旋优化策略，具体如下： </p>
<p>如果平均负载小于CPUs则一直自旋 </p>
<p>如果有超过(CPUs/2)个线程正在自旋，则后来线程直接阻塞 </p>
<p>如果正在自旋的线程发现Owner发生了变化则延迟自旋时间（自旋计数）或进入阻塞 </p>
<p>如果CPU处于节电模式则停止自旋 </p>
<p>自旋时间的最坏情况是CPU的存储延迟（CPU A存储了一个数据，到CPU B得知这个数据直接的时间差） </p>
<p>自旋时会适当放弃线程优先级之间的差异 </p>
<p>那synchronized实现何时使用了自旋锁？答案是在线程进入ContentionList时，也即第一步操作前。线程在进入等待队列时 首先进行自旋尝试获得锁，如果不成功再进入等待队列。这对那些已经在等待队列中的线程来说，稍微显得不公平。还有一个不公平的地方是自旋线程可能会抢占了 Ready线程的锁。自旋锁由每个监视对象维护，每个监视对象一个。</p>
</li>
<li><p>偏向锁</p>
<p>在JVM1.6中引入了偏向锁，偏向锁主要解决无竞争下的锁性能问题，首先我们看下无竞争下锁存在什么问题： </p>
<p>现在几乎所有的锁都是可重入的，也即已经获得锁的线程可以多次锁住/解锁监视对象，按照之前的HotSpot设计，每次加锁/解锁都会涉及到一些 CAS操 作（比如对等待队列的CAS操作），CAS操作会延迟本地调用，因此偏向锁的想法是一旦线程第一次获得了监视对象，之后让监视对象“偏向”这个 线程，之后的多次调用则可以避免CAS操作，说白了就是置个变量，如果发现为true则无需再走各种加锁/解锁流程。但还有很多概念需要解释、很多引入的 问题需要解决：</p>
<p><img src="http://img.andrewchen1.top/20121109112521_777.jpg" alt="SMP"></p>
<p>其意思是所有的CPU会共享一条系统总线（BUS），靠此总线连接主存。每个核都有自己的一级缓存，各核相对于BUS对称分布，因此这种结构称为“对称多处理器”。 </p>
<p>而CAS的全称为Compare-And-Swap，是一条CPU的原子指令，其作用是让CPU比较后原子地更新某个位置的值，经过调查发现， 其实现方式是基于硬件平台的汇编指令，就是说CAS是靠硬件实现的，JVM只是封装了汇编调用，那些AtomicInteger类便是使用了这些封装后的 接口。 </p>
<p>Core1和Core2可能会同时把主存中某个位置的值Load到自己的L1 Cache中，当Core1在自己的L1 Cache中修改这个位置的值时，会通过总线，使Core2中L1 Cache对应的值“失效”，而Core2一旦发现自己L1 Cache中的值失效（称为Cache命中缺失）则会通过总线从内存中加载该地址最新的值，大家通过总线的来回通信称为“Cache一致性流量”，因为总 线被设计为固定的“通信能力”，如果Cache一致性流量过大，总线将成为瓶颈。而当Core1和Core2中的值再次一致时，称为“Cache一致 性”，从这个层面来说，锁设计的终极目标便是减少Cache一致性流量。 </p>
<p>而CAS恰好会导致Cache一致性流量，如果有很多线程都共享同一个对象，当某个Core CAS成功时必然会引起总线风暴，这就是所谓的本地延迟，本质上偏向锁就是为了消除CAS，降低Cache一致性流量。</p>
</li>
</ul>
<p>  上面提到Cache一致性，其实是有协议支持的，现在通用的协议是MESI（最早由Intel开始支持），具体参考：<a href="http://en.wikipedia.org/wiki/MESI_protocol" target="_blank" rel="noopener">http://en.wikipedia.org/wiki/MESI_protocol</a>，以后会仔细讲解这部分。</p>
<p>  其实也不是所有的CAS都会导致总线风暴，这跟Cache一致性协议有关，具体参考：<a href="http://blogs.oracle.com/dave/entry/biased_locking_in_hotspot" target="_blank" rel="noopener">http://blogs.oracle.com/dave/entry/biased_locking_in_hotspot</a></p>
<p>  NUMA(Non Uniform Memory Access Achitecture）架构： </p>
<p>  与SMP对应还有非对称多处理器架构，现在主要应用在一些高端处理器上，主要特点是没有总线，没有公用主存，每个Core有自己的内存，针对这种结构此处不做讨论。</p>
</blockquote>
<h3 id="ReentrantLock"><a href="#ReentrantLock" class="headerlink" title="ReentrantLock"></a>ReentrantLock</h3><p>他是一种重入锁,除了能完成sychronized所能完成的所有工作之外,还提供了诸如可响应中断锁、可轮训锁、定时锁能避免多线程死锁的方法.</p>
<ol>
<li><p>void lock() </p>
<p>如果锁处于空闲的状态,当前线程将获得锁</p>
</li>
<li><p>boolean tryLock() </p>
<p>如果锁可用,则获得锁,并且立即返回true,否则返回false.tryLock只是”试图”获取锁,如果锁不可用,不会导致这个线程处于wait状态</p>
</li>
<li><p>void unlock()</p>
<p>当前线程将释放持有的锁</p>
</li>
<li><p>Condition newCondition()</p>
<p>条件对象,获取等待通知组件. 该组件和当前的锁绑定.<strong>当前线程只有拥有了锁</strong>,才能调用该组件的await()方法.而调用了之后,当前线程会释放lock, 被加入到这个condition的等待队列中,这个线程不再会活动,until 其他线程操作这个conditional 调用signal()或者 signalAll(). 被await的线程会到lock的竞争队列中去竞争condition.</p>
</li>
<li><p>int getHoldCount()</p>
<p>查询当前线程保持此锁的次数, 重入的次数,也就是执行此线程执行lock方法的次数</p>
</li>
<li><p>int getQueueLength()</p>
<p>返回正等待获取此锁的线程数量</p>
</li>
<li><p>int getWaitQueueLength(Condition condition)</p>
<p>返回等待与此锁相关的给定条件线程估计数.比方说10个线程,用同一个condition对象,而且10对象都执行了await的方法.那么返回的值为10</p>
</li>
<li><p>bool hasWaiters(Condition condition)</p>
<p>某个Condition 是否有等待的Thread数量</p>
</li>
<li><p>boolean hasQueuedThread(Thread thread)</p>
<p>查询给定的线程是否拥有这个锁</p>
</li>
<li><p>boolean hasQueuedThreads()</p>
<p>是否有线程在等待这个lock</p>
</li>
<li><p>isFair()</p>
<p>是否是公平锁</p>
</li>
<li><p>isHeldByCurrentThread()</p>
<p>这个lock是不是被当前线程占有</p>
</li>
<li><p>isLock()</p>
<p>这个锁是否被其他线程占用</p>
</li>
<li><p>lockInterruptibly()</p>
<p>尝试获取锁,仅在调用时锁未被中断,获取锁</p>
</li>
<li><p>tryLock(Long timeout, TimeUnit unit)</p>
<p>在给定的时间内尝试获取锁,如果没有获取到,则放弃</p>
</li>
</ol>
<h3 id="公平锁和非公平锁"><a href="#公平锁和非公平锁" class="headerlink" title="公平锁和非公平锁"></a>公平锁和非公平锁</h3><p>JVM 按随机、就近原则分配原则锁的机制则称为不公平锁,按照对锁提出获取请求的先后顺序分配到锁的机制被称为公平锁</p>
<h3 id="ReetrantLock-与-Sychronized"><a href="#ReetrantLock-与-Sychronized" class="headerlink" title="ReetrantLock 与 Sychronized"></a>ReetrantLock 与 Sychronized</h3><p>reetrantLock通过lock()和unlock() 实现加锁和解锁. ReetrantLock 必须在finally控制块中进行解锁操作.</p>
<h3 id="Semaphore"><a href="#Semaphore" class="headerlink" title="Semaphore"></a>Semaphore</h3><p>Semaphore是一种基于基数的型号量.它可以设定一个阈值.多个线程获取许可型号(acquire),做完自己的申请后归还(release)</p>
<h3 id="共享锁和独占锁"><a href="#共享锁和独占锁" class="headerlink" title="共享锁和独占锁"></a>共享锁和独占锁</h3><p>独占锁模式下,每次只有一个线程能持有锁.共享锁允许多个线程同时获取锁,并发共享资源. 比方说ReadWriteLock.</p>
<table>
<thead>
<tr>
<th align="center"></th>
<th>READ</th>
<th>WRITE</th>
</tr>
</thead>
<tbody><tr>
<td align="center">READ</td>
<td>☑️</td>
<td>✖️</td>
</tr>
<tr>
<td align="center">WRITE</td>
<td>✖️</td>
<td>✖️</td>
</tr>
</tbody></table>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyReadWriteReetraintLock</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 目前正在读的数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> Integer readerNumber;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 正在读的数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> Integer writerNumber;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyReadWriteReetraintLock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        readerNumber = <span class="number">0</span>;</span><br><span class="line">        writerNumber = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">tryRead</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (writerNumber &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            wait();</span><br><span class="line">        &#125;</span><br><span class="line">        readerNumber ++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">readDone</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        readerNumber --;</span><br><span class="line">        notifyAll();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">tryWrite</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (readerNumber &gt; <span class="number">0</span> || writerNumber &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            wait();</span><br><span class="line">        &#125;</span><br><span class="line">        writerNumber ++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">writeDone</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        writerNumber --;</span><br><span class="line">        notifyAll();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="Interrupt"><a href="#Interrupt" class="headerlink" title="Interrupt"></a>Interrupt</h3><p>中断一个线程,本意是给这个线程一个通知信号,会影响这个线程内部一个中断标识.</p>
<ul>
<li>运行中的线程不能响应interrupt. 但是标识位会被设置.可以通过isInterrupted方法来知晓标识位的状态</li>
<li>在阻塞状态的进程被调用interrupt方法会抛出InterruptedException, 在抛出错误后会将标识位清除.</li>
</ul>
<h3 id="线程池的组成"><a href="#线程池的组成" class="headerlink" title="线程池的组成"></a>线程池的组成</h3><ul>
<li>线程池管理器</li>
<li>工作线程</li>
<li>任务接口</li>
<li>任务队列</li>
</ul>
<p>构建一个线程池</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ExecutorService threadPool = <span class="keyword">new</span> ThreadPoolExecutor(</span><br><span class="line">                Runtime.getRuntime().availableProcessors(),</span><br><span class="line">                <span class="number">10</span>, </span><br><span class="line">                <span class="number">100</span>, </span><br><span class="line">                TimeUnit.SECONDS, </span><br><span class="line">                <span class="keyword">new</span> LinkedBlockingQueue&lt;&gt;(),</span><br><span class="line">                <span class="keyword">new</span> ThreadPoolExecutor.CallerRunsPolicy());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="拒绝策略"><a href="#拒绝策略" class="headerlink" title="拒绝策略"></a>拒绝策略</h4><p>当线程池里面所有的线程都在运行中, 并且队列都满了情况下有若干的拒绝方式</p>
<ul>
<li><p>AbortPolicy  </p>
<p>直接抛出异常,阻止系统正常运行</p>
</li>
<li><p>CellerRunsPolicy</p>
</li>
</ul>
<p>​    该策略直接在调用者线程中运行当前被丢弃的任务. 优点不会真的丢弃任务. 但是任务提交的性能可能会急剧下降</p>
<ul>
<li>DiscardOldestPolicy</li>
</ul>
<p>​    抛弃队列中最老的线程</p>
<ul>
<li>DiscardPolicy</li>
</ul>
<p>​    默默的丢弃将要处理的任务不做任何的处理</p>
<h3 id="线程池的工作流程"><a href="#线程池的工作流程" class="headerlink" title="线程池的工作流程"></a>线程池的工作流程</h3><p>当调用execute()方法添加一个任务的时候,线程池会做如下判断:</p>
<p>a. 如果正在运行的线程数量小于corePoolSize, 会马上创建线程运行这个任务</p>
<p>b. 如果运行的线程数量大于或者等于corePoolSize 会将这个任务放入队列</p>
<p>c. 如果队列满了, 线程数量小于maximumPoolSize, 那么还是要创建非核心线程来运行这个任务</p>
<p>f. 如果队列满了,而且现在正在运行的线程数量大于或者等于maximumPoolSize,那么线程池会抛出RejectExecutionExecution;</p>
<p>当一个线程无事可做,超过一定时间,线程池会判断,如果当前运行的线程数量大于corePoolSize,那么这个线程就会被停掉,最终线程池会被压缩到corePoolSize的大小</p>
<p>队列的方法</p>
<table>
<thead>
<tr>
<th></th>
<th>插入</th>
<th>移除</th>
<th>检查</th>
</tr>
</thead>
<tbody><tr>
<td>会抛出异常</td>
<td>add</td>
<td>remove</td>
<td>element</td>
</tr>
<tr>
<td>不会抛出异常</td>
<td>offer</td>
<td>poll</td>
<td>peek</td>
</tr>
<tr>
<td>阻塞</td>
<td>put</td>
<td>take</td>
<td></td>
</tr>
</tbody></table>
<ul>
<li><p>ArrayBlockingQueue</p>
<p>数组形式实现的有界阻塞队列</p>
</li>
<li><p>LinkedBlockingQueue</p>
<p>对于<strong>消费者</strong>和<strong>生产者</strong> 采用不同的锁来控制数据同步 生产者不停的在队尾增加内容. 消费者不停的在队列头部生产内容</p>
</li>
<li><p>PriorityBlockingQueue</p>
<p>队列使用大根堆的方式进行组织的. 每次取堆的根节点.每次添加内容后会进行堆的rearrange.</p>
</li>
<li><p>DelayQueue</p>
<p>也是用小根堆的方式进行组织, 以延迟的时间作为权重值, 每次都从队列中取内容, 然后delay指定的时间</p>
</li>
<li><p>SynchronousQueue</p>
<p>每一个put必须等待一个take操作.可以看作是一个数据暂存的地方</p>
</li>
<li><p>LinkedTransferQueue</p>
<p>由一个链表组成的无界阻塞TransferQueue队列.相对于LinkedBlockingQueue多了transfer()方法</p>
</li>
</ul>
<h4 id="CountDownLunch"><a href="#CountDownLunch" class="headerlink" title="CountDownLunch"></a>CountDownLunch</h4><h4 id="CyclicBarrier"><a href="#CyclicBarrier" class="headerlink" title="CyclicBarrier"></a>CyclicBarrier</h4><h4 id="Semaphore-1"><a href="#Semaphore-1" class="headerlink" title="Semaphore"></a>Semaphore</h4><h3 id="Volatile"><a href="#Volatile" class="headerlink" title="Volatile"></a>Volatile</h3><p> 在 JMM（Java Memory Model）数据的执行主要分为 lock、unlock、read、load、use、assign、store、write。 </p>
<blockquote>
<ul>
<li>read（读取）：作用于主内存变量，把一个变量值从主内存传输到线程的工作内存中，以便随后的load动作使用</li>
<li>load（载入）：作用于工作内存的变量，它把read操作从主内存中得到的变量值放入工作内存的变量副本中。</li>
<li>use（使用）：作用于工作内存的变量，把工作内存中的一个变量值传递给执行引擎，每当虚拟机遇到一个需要使用变量的值的字节码指令时将会执行这个操作。</li>
<li>assign（赋值）：作用于工作内存的变量，它把一个从执行引擎接收到的值赋值给工作内存的变量，每当虚拟机遇到一个给变量赋值的字节码指令时执行这个操作。</li>
<li>store（存储）：作用于工作内存的变量，把工作内存中的一个变量的值传送到主内存中，以便随后的write的操作。</li>
<li>write（写入）：作用于主内存的变量，它把store操作从工作内存中一个变量的值传送到主内存的变量中。</li>
</ul>
</blockquote>
<p> 这些行为是不可分解的原子操作，在使用上相互依赖，read-load从主内存复制变量到当前工作内存，use-assign执行代码改变共享变量值，store-write用工作内存数据刷新主存相关内容。</p>
<p>要保证所谓的多线程的数据执行正确，就是要保证happen-before。A操作如果发生在B操作之前，那么我们能保证数据的正确。所以我们需要内存屏障的帮助， Java内存屏障主要分为四种，它保证在栅栏前初始化的load和store指令，能够严格有序的在栅栏后的load和store指令之前执行。</p>
<ul>
<li><p>Load - Load</p>
<p>确保Load1所要读入的数据能够在被Load2和后续的load指令访问前读入。</p>
</li>
<li><p>Store-Store</p>
<p>确保Store1的数据在Store2以及后续Store指令操作相关数据之前对其它处理器可见（例如向主存刷新数据）</p>
</li>
<li><p>Load-Store</p>
<p>确保Load1的数据在Store2和后续Store指令被刷新之前读取。</p>
</li>
<li><p>Store-Load</p>
<p><a href="http://ifeve.com/jmm-cookbook-mb/" target="_blank" rel="noopener">ifever</a></p>
<blockquote>
<p>确保Store1的数据在被Load2和后续的Load指令读取之前对其他处理器可见。StoreLoad屏障可以防止一个后续的load指令 不正确的使用了Store1的数据，而不是另一个处理器在相同内存位置写入一个新数据。正因为如此，所以在下面所讨论的处理器为了在屏障前读取同样内存位置存过的数据，必须使用一个StoreLoad屏障将存储指令和后续的加载指令分开。Storeload屏障在几乎所有的现代多处理器中都需要使用，但通常它的开销也是最昂贵的。它们昂贵的部分原因是它们必须关闭通常的略过缓存直接从写缓冲区读取数据的机制。这可能通过让一个缓冲区进行充分刷新（flush）,以及其他延迟的方式来实现。</p>
<p>在下面讨论的所有处理器中，执行StoreLoad的指令也会同时获得其他三种屏障的效果。所以StoreLoad可以作为最通用的（但通常也是最耗性能）的一种Fence。(这是经验得出的结论，并不是必然)。反之不成立，为了达到StoreLoad的效果而组合使用其他屏障并不常见。</p>
</blockquote>
</li>
</ul>
<h4 id="ThreadLocal-作用"><a href="#ThreadLocal-作用" class="headerlink" title="ThreadLocal 作用"></a>ThreadLocal 作用</h4><p><a href="https://www.jianshu.com/p/98b68c97df9b" target="_blank" rel="noopener">ThreadLocal的说明1</a></p>
<p><a href="https://www.jianshu.com/p/a1cd61fa22da" target="_blank" rel="noopener">ThreadLocal的说明2</a></p>
<p>这两篇说的很清楚了</p>
<p>每个Thread 对象内部都有ThreadMap&lt;Entity,  T&gt;类型的属性，其中Entity extend WeakReference &lt; ThreadLocal&gt;的定义为.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Entry</span> <span class="keyword">extends</span> <span class="title">WeakReference</span>&lt;<span class="title">ThreadLocal</span>&lt;?&gt;&gt; </span>&#123;</span><br><span class="line">            <span class="comment">/** The value associated with this ThreadLocal. */</span></span><br><span class="line">            Object value;</span><br><span class="line"></span><br><span class="line">            Entry(ThreadLocal&lt;?&gt; k, Object v) &#123;</span><br><span class="line">                <span class="keyword">super</span>(k);</span><br><span class="line">                value = v;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p><a href="https://www.jianshu.com/p/964fbc30151a" target="_blank" rel="noopener">WeakReferences说明</a></p>
<p>WeakReference如字面意思，弱引用， 当一个对象仅仅被weak reference（弱引用）指向，而没有任何其他strong reference（强引用）指向的时候, 如果这时GC运行, 那么这个对象就会被回收。我们定义了Entity， 其中ThreadLocal 是弱引用，value 是强引用。 Entity中的ThreadLocal的值能被顺利的GC， 但是value中的值不能呗顺利的GC， 需要手动的设置，让JVM 让其GC。</p>
<p>每次ThreadLocal的set和get方法实质是在ThreadMap中放置或者读取值</p>
<p><strong>ThreadLocal 内存泄露问题</strong></p>
<p>在程序的上下文中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dosomething</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  ThreadLocal&lt;String&gt; name = <span class="keyword">new</span> ThreadLocal&lt;&gt;();</span><br><span class="line">  name.set(<span class="string">"something"</span>);</span><br><span class="line">  <span class="comment">// do something else </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么在结束之后， name会被gc， 因为entity的定义， 其对象也会被回收，但是ThreadLocalMap 中的table[i] 中还是放着value的值，导致<strong>内存泄漏</strong> 比较建议的做法是</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dosomething</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  ThreadLocal&lt;String&gt; name = <span class="keyword">new</span> ThreadLocal&lt;&gt;();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line"> 		name.set(<span class="string">"something"</span>);</span><br><span class="line">  	<span class="comment">// do something else </span></span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    name.remove();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ReetrantLock和Synchronized-之间的区别"><a href="#ReetrantLock和Synchronized-之间的区别" class="headerlink" title="ReetrantLock和Synchronized 之间的区别"></a>ReetrantLock和Synchronized 之间的区别</h3><ol>
<li>ReentrantLock 显示的获得锁和释放锁， Synchronized隐式的获得锁</li>
<li>ReentrantLock可响应中断， Synchronized不可以</li>
<li>ReetrantLock 是api级别 Sychronized 是JVM 级别</li>
<li>ReetrantLock 可以实现公平锁</li>
<li>ReetrantLock 通过condition可以绑定多个条件</li>
<li>synchronized 是同步阻塞， lock是同步非阻塞</li>
<li>synchronized发生异常的时候会自动释放锁，而Lock需要在finally中调用unlock()</li>
<li>通过Lock可以知道是否获得锁，而Synchronized不可以</li>
</ol>
<h3 id="ConcurrentHashMap"><a href="#ConcurrentHashMap" class="headerlink" title="ConcurrentHashMap"></a>ConcurrentHashMap</h3><p>concurrentHashMap的效率要比HashTable效率高的原因是ConcurrentHashMap采用了分片的策略，默认分为16片。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://www.andrewchen1.top/2019/08/11/Java-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E7%82%B9%E6%95%B4%E7%90%862/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="小夫">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小夫的笔记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/08/11/Java-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E7%82%B9%E6%95%B4%E7%90%862/" class="post-title-link" itemprop="url">Java 基础知识点整理2</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2019-08-11 14:44:02 / Modified: 16:22:35" itemprop="dateCreated datePublished" datetime="2019-08-11T14:44:02+08:00">2019-08-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" itemprop="url" rel="index"><span itemprop="name">Java基础知识</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Java-集合"><a href="#Java-集合" class="headerlink" title="Java 集合"></a>Java 集合</h1><h2 id="集合框架"><a href="#集合框架" class="headerlink" title="集合框架"></a>集合框架</h2><h3 id="Collection"><a href="#Collection" class="headerlink" title="Collection"></a>Collection</h3><h4 id="List"><a href="#List" class="headerlink" title="List"></a>List</h4><ul>
<li><p>ArrayList</p>
<ol>
<li><p>按照插入顺序排序, 可重复</p>
</li>
<li><p>底层使用数组</p>
</li>
<li><p>可以随机进行读取、增删慢 (要挪元素在数组中的位置)</p>
</li>
<li><p>线程不安全</p>
</li>
</ol>
<p><a href="https://blog.csdn.net/wchicho/article/details/51987992" target="_blank" rel="noopener">ConcurrentModificationException分析</a> </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Integer&gt; list = <span class="keyword">new</span> ArrayList&lt;Integer&gt;();</span><br><span class="line">list.add(<span class="number">1</span>);</span><br><span class="line">list.add(<span class="number">2</span>);</span><br><span class="line">list.add(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	* example 1</span></span><br><span class="line"><span class="comment">	* 在这个情况下不会抛错</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">  <span class="keyword">int</span> length = list.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (list.get(i).equals(<span class="number">2</span>)) &#123;</span><br><span class="line">                list.add(<span class="number">10</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">		* example 2</span></span><br><span class="line"><span class="comment">		* 在这种情况下会抛错</span></span><br><span class="line"><span class="comment">		*/</span></span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">int</span> temp : list) &#123;</span><br><span class="line">    <span class="keyword">if</span>(temp == <span class="number">2</span>) &#123;</span><br><span class="line">      list.add(<span class="number">10</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * exmple 3</span></span><br><span class="line"><span class="comment"> * 在这种情况下会抛错</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">Iterator&lt;Integer&gt; iterator = list.iterator();</span><br><span class="line"><span class="keyword">while</span>(iterator.hasNext()) &#123;</span><br><span class="line">  <span class="keyword">if</span>(iterator.next().equals(<span class="number">2</span>)) &#123;</span><br><span class="line">    list.add(<span class="number">10</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * example 4</span></span><br><span class="line"><span class="comment"> * 在这种情况下不会抛错</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">ListIterator&lt;Integer&gt; listIterator = list.listIterator();</span><br><span class="line"><span class="keyword">while</span> (listIterator.hasNext()) &#123;</span><br><span class="line">  <span class="keyword">if</span> (listIterator.next().equals(<span class="number">2</span>)) &#123;</span><br><span class="line">    listIterator.add(<span class="number">10</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>会抛出错误的原因</p>
<p>在ArrayList 内有个内部类Itr</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">Itr</span> <span class="keyword">implements</span> <span class="title">Iterator</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 预期修改(modification)次数</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">int</span> expectedModCount = modCount;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在迭代器调用next 方法的时候会检查当前类的修改次数和迭代器内的修改次数是不是一致, 如果是不一致的话 就爆炸.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	checkForComodification();</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="keyword">int</span> i = cursor;</span><br><span class="line">		E next = get(i);</span><br><span class="line">		lastRet = i;</span><br><span class="line">		cursor = i + <span class="number">1</span>;</span><br><span class="line">		<span class="keyword">return</span> next;</span><br><span class="line">	&#125; <span class="keyword">catch</span>(IndexOutOfBoundsException e) &#123;</span><br><span class="line">		checkForComodification();</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> NoSuchElementException();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">add</span><span class="params">(E e)</span> </span>&#123;</span><br><span class="line">	checkForComodification();</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="keyword">int</span> i = cursor;</span><br><span class="line">		ArrayList.<span class="keyword">this</span>.add(i, e);</span><br><span class="line">		cursor = i + <span class="number">1</span>;</span><br><span class="line">		lastRet = -<span class="number">1</span>;</span><br><span class="line">		exceptedModCount = modCount;</span><br><span class="line">	&#125; <span class="keyword">catch</span> (IndexOutOfBoundException ex) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> ConcurrentModificationException();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在案例1 中没有使用到迭代器相关的api</p>
<p>在案例 2, 3 中使用了迭代器相关的api 在外部类的mod time 发生了改变的时候没有对迭代器内部的mod time 同时进行修正, 当再次调用next 的时候发现内部类记录的修改次数和类外部的修改次数不一样.爆炸.</p>
</li>
<li><p>Vector</p>
<ol>
<li>按照插入顺序排序 可重复</li>
<li>底层使用数组</li>
<li>可以随机读取 增删慢(要挪元素在数组中的位置)</li>
<li>线程安全</li>
</ol>
</li>
<li><p>LinkedList</p>
<ol>
<li>按照插入顺序排序 元素可重复</li>
<li>通过链表的方式保存数据</li>
<li>不可以随机读取数据 要通过头节点 或者尾节点 以遍历的方式获得所得的元素 但是 add 和remove的方法快</li>
</ol>
</li>
</ul>
<h4 id="Set"><a href="#Set" class="headerlink" title="Set"></a>Set</h4><ul>
<li><p>HashSet</p>
<p>排列无序 不可重复 底层是HashMap. </p>
</li>
<li><p>TreeSet</p>
<p>内部是TreeMap的sortedSet</p>
</li>
<li><p>LinkedHashSet</p>
<p>内部是LinkedHashMap</p>
</li>
</ul>
<h4 id="Queued"><a href="#Queued" class="headerlink" title="Queued"></a>Queued</h4><ul>
<li>PriorityQueued</li>
</ul>
<h3 id="Map"><a href="#Map" class="headerlink" title="Map"></a>Map</h3><ul>
<li><p>HashMap</p>
<p>key不可重复 value 可以重复</p>
<p>底层hash表</p>
<p>线程不安全 (可能会造成endless loop)</p>
<p>允许key值为null</p>
</li>
<li><p>HashTable</p>
<p>key不可重复</p>
<p>底层hashtable</p>
<p>线程安全</p>
<p>key value 都不允许为null</p>
</li>
<li><p>TreeMap</p>
<p>key不可以重复</p>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://www.andrewchen1.top/2019/08/10/mybatis-chapter2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="小夫">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小夫的笔记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/08/10/mybatis-chapter2/" class="post-title-link" itemprop="url">mybatis chapter2</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-08-10 17:06:12" itemprop="dateCreated datePublished" datetime="2019-08-10T17:06:12+08:00">2019-08-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-08-11 13:56:05" itemprop="dateModified" datetime="2019-08-11T13:56:05+08:00">2019-08-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MyBatis%E5%86%85%E5%B9%95/" itemprop="url" rel="index"><span itemprop="name">MyBatis内幕</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="基础支持层"><a href="#基础支持层" class="headerlink" title="基础支持层"></a>基础支持层</h1><h2 id="解析器模块"><a href="#解析器模块" class="headerlink" title="解析器模块"></a>解析器模块</h2><ul>
<li>Dom</li>
<li>SAX</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://www.andrewchen1.top/2019/08/10/mybatis-chapter1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="小夫">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小夫的笔记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/08/10/mybatis-chapter1/" class="post-title-link" itemprop="url">mybatis chapter1</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-08-10 15:56:45" itemprop="dateCreated datePublished" datetime="2019-08-10T15:56:45+08:00">2019-08-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-08-11 13:57:06" itemprop="dateModified" datetime="2019-08-11T13:57:06+08:00">2019-08-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MyBatis%E5%86%85%E5%B9%95/" itemprop="url" rel="index"><span itemprop="name">MyBatis内幕</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="MyBatis-快速入门"><a href="#MyBatis-快速入门" class="headerlink" title="MyBatis 快速入门"></a>MyBatis 快速入门</h1><h2 id="Mybatis示例"><a href="#Mybatis示例" class="headerlink" title="Mybatis示例"></a>Mybatis示例</h2><p>配置文件</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"&gt;</span></span><br><span class="line"><span class="meta">    &lt;!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd"/&gt;</span></span><br><span class="line"><span class="meta">    &lt;configuration&gt;</span></span><br><span class="line"><span class="meta">        &lt;properites&gt;</span></span><br><span class="line"><span class="meta">            &lt;property name = "username" value ="root"/&gt;</span></span><br><span class="line"><span class="meta">            &lt;property name = "id" value = "123"/&gt;</span></span><br><span class="line"><span class="meta">        &lt;/properites&gt;</span></span><br><span class="line"><span class="meta">        &lt;settings&gt;</span></span><br><span class="line"><span class="meta">            &lt;setting name="cacheEnabled" value = "true"/&gt;</span></span><br><span class="line"><span class="meta">        &lt;/settings&gt;</span></span><br><span class="line"><span class="meta">        &lt;typeAliases&gt;</span></span><br><span class="line"><span class="meta">            &lt;typeAlias type = "com.xxx.Blog" alias = "Blog"/&gt;</span></span><br><span class="line"><span class="meta">        &lt;/typeAliases&gt;</span></span><br><span class="line"><span class="meta">        &lt;enviroments default = "development"&gt;</span></span><br><span class="line"><span class="meta">            &lt;enviroment id = "development"&gt;</span></span><br><span class="line"><span class="meta">                &lt;transcationManager type="JDBC"/&gt;</span></span><br><span class="line"><span class="meta">                &lt;dataSource type="POOLED"&gt;</span></span><br><span class="line"><span class="meta">                    &lt;property name="driver" value = "com.mysql.jdbc.Driver"/&gt;</span></span><br><span class="line"><span class="meta">                    &lt;property name="url" value="jdbc:mysql://localhost:3306/test"/&gt;</span></span><br><span class="line"><span class="meta">                    &lt;property name="username" value="root"/&gt;</span></span><br><span class="line"><span class="meta">                    &lt;property name="password" value=""/&gt;</span></span><br><span class="line"><span class="meta">                &lt;/dataSource&gt;</span></span><br><span class="line"><span class="meta">            &lt;/enviroment&gt;</span></span><br><span class="line"><span class="meta">        &lt;/enviroments&gt;</span></span><br><span class="line"><span class="meta">        &lt;mappers&gt;</span></span><br><span class="line"><span class="meta">            &lt;mapper resource="com/***/BlogMapper.xml"/&gt;</span></span><br><span class="line"><span class="meta">        &lt;/mappers&gt;            </span></span><br><span class="line"><span class="meta">    &lt;/configuration&gt;</span></span><br><span class="line"><span class="meta">&lt;/xml&gt;</span></span><br></pre></td></tr></table></figure>

<p>执行的java代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String resource = <span class="string">"com/xxx/mybatis-config.xml"</span>;</span><br><span class="line">        InputStream inputStream = Resources.getResourceAsStream(resource);</span><br><span class="line">        SqlSessionFactory sqlSessionFactory = <span class="keyword">new</span> SqlSessionFactoryBuillder().build(inputStream);</span><br><span class="line"></span><br><span class="line">        SqlSession sqlsession = sqlSessionFactory.openSession();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Map&lt;String,Object&gt; parameter = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">            parameter.put(<span class="string">"id"</span>, <span class="number">1</span>);</span><br><span class="line">            Blog blog = sqlSession.selectOne(<span class="string">"com.xxx.BlogMapper.selectBlogDetails"</span>, parameter);</span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">        &#125; <span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="MyBatis-整体架构"><a href="#MyBatis-整体架构" class="headerlink" title="MyBatis 整体架构"></a>MyBatis 整体架构</h2><h3 id="基础支持层"><a href="#基础支持层" class="headerlink" title="基础支持层"></a>基础支持层</h3><ul>
<li><p>反射模块</p>
</li>
<li><p>类型转换模块</p>
<p>jdbcType和JavaType之间类型做转换</p>
</li>
<li><p>日志模块</p>
</li>
<li><p>资源加载模块</p>
<p>对类加载器进行封装</p>
</li>
<li><p>解析器模块</p>
<p>对Xpath进行封装 为config处理提供支持 </p>
<p>为处理sql语言中的占位符提供支持</p>
</li>
<li><p>数据源模块</p>
</li>
<li><p>事务管理</p>
</li>
<li><p>缓存模块</p>
</li>
<li><p>Binding模块</p>
</li>
</ul>
<h3 id="核心处理层"><a href="#核心处理层" class="headerlink" title="核心处理层"></a>核心处理层</h3><ul>
<li><p>配置解析</p>
</li>
<li><p>Sql解析与sripting 模块</p>
</li>
<li><p>Sql执行</p>
<p>sqlSession -&gt; executor -&gt; statementHandler -&gt; parameterHandler -&gt; statement -&gt; db -&gt; resultSet -&gt;ResultSetHandler -&gt; StatementHandler -&gt;executor -&gt; sqlSession </p>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

  </div>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="小夫"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">小夫</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">27</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/andrewchen1" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;andrewchen1" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:andrewchen7@outlook.com" title="E-Mail → mailto:andrewchen7@outlook.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="http://weibo.com/312228489" title="微博 → http:&#x2F;&#x2F;weibo.com&#x2F;312228489" rel="noopener" target="_blank"><i class="fa fa-fw fa-weibo"></i>微博</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        
  <div class="beian"><a href="http://www.beian.miit.gov.cn/" rel="noopener" target="_blank">浙ICP备18051892号 </a>
  </div>

<div class="copyright">
  
  &copy; 2018 – 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">小夫</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> v4.2.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Theme – <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v7.7.2
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
